<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"chuxiaoyi.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"mac"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":true,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="cxy">
<meta property="og:url" content="https://chuxiaoyi.github.io/page/4/index.html">
<meta property="og:site_name" content="cxy">
<meta property="og:locale">
<meta property="article:author" content="chuxiaoyi">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://chuxiaoyi.github.io/page/4/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-Hans'
  };
</script>

  <title>cxy</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">cxy</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags<span class="badge">29</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories<span class="badge">8</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives<span class="badge">41</span></a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

  <a href="https://github.com/ChuXiaoYi" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://chuxiaoyi.github.io/2018/09/13/py3.7%E6%A0%87%E5%87%86%E5%BA%93-collections-Counter/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="chuxiaoyi">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="cxy">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/09/13/py3.7%E6%A0%87%E5%87%86%E5%BA%93-collections-Counter/" class="post-title-link" itemprop="url">py3.7标准库-collections-Counter</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-09-13 19:17:16" itemprop="dateCreated datePublished" datetime="2018-09-13T19:17:16+08:00">2018-09-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-06-10 18:16:29" itemprop="dateModified" datetime="2021-06-10T18:16:29+08:00">2021-06-10</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>6k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>5 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <span id="more"></span>

<h2 id="Counter"><a href="#Counter" class="headerlink" title="Counter"></a><strong>Counter</strong></h2><p>实现：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">collections</span>.<span class="title">Counter</span>(<span class="params">[iterable-<span class="keyword">or</span>-mapping]</span>)</span></span><br></pre></td></tr></table></figure>

<p>源码中，简单介绍了一些用法：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>c = Counter(<span class="string">&#x27;abcdeabcdabcaba&#x27;</span>)  <span class="comment"># count elements from a string</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>c.most_common(<span class="number">3</span>)                <span class="comment"># three most common elements</span></span><br><span class="line">[(<span class="string">&#x27;a&#x27;</span>, <span class="number">5</span>), (<span class="string">&#x27;b&#x27;</span>, <span class="number">4</span>), (<span class="string">&#x27;c&#x27;</span>, <span class="number">3</span>)]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">sorted</span>(c)                       <span class="comment"># list all unique elements</span></span><br><span class="line">[<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;d&#x27;</span>, <span class="string">&#x27;e&#x27;</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">&#x27;&#x27;</span>.join(<span class="built_in">sorted</span>(c.elements()))   <span class="comment"># list elements with repetitions</span></span><br><span class="line"><span class="string">&#x27;aaaaabbbbcccdde&#x27;</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">sum</span>(c.values())                 <span class="comment"># total of all counts</span></span><br><span class="line"><span class="number">15</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>c[<span class="string">&#x27;a&#x27;</span>]                          <span class="comment"># count of letter &#x27;a&#x27;</span></span><br><span class="line"><span class="number">5</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">for</span> elem <span class="keyword">in</span> <span class="string">&#x27;shazam&#x27;</span>:           <span class="comment"># update counts from an iterable</span></span><br><span class="line"><span class="meta">... </span>    c[elem] += <span class="number">1</span>                <span class="comment"># by adding 1 to each element&#x27;s count</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>c[<span class="string">&#x27;a&#x27;</span>]                          <span class="comment"># now there are seven &#x27;a&#x27;</span></span><br><span class="line"><span class="number">7</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">del</span> c[<span class="string">&#x27;b&#x27;</span>]                      <span class="comment"># remove all &#x27;b&#x27;</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>c[<span class="string">&#x27;b&#x27;</span>]                          <span class="comment"># now there are zero &#x27;b&#x27;</span></span><br><span class="line"><span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d = Counter(<span class="string">&#x27;simsalabim&#x27;</span>)       <span class="comment"># make another counter</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>c.update(d)                     <span class="comment"># add in the second counter</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>c[<span class="string">&#x27;a&#x27;</span>]                          <span class="comment"># now there are nine &#x27;a&#x27;</span></span><br><span class="line"><span class="number">9</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>c.clear()                       <span class="comment"># empty the counter</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>c</span><br><span class="line">Counter()</span><br><span class="line"></span><br><span class="line">Note:  If a count <span class="keyword">is</span> <span class="built_in">set</span> to zero <span class="keyword">or</span> reduced to zero, it will remain</span><br><span class="line"><span class="keyword">in</span> the counter until the entry <span class="keyword">is</span> deleted <span class="keyword">or</span> the counter <span class="keyword">is</span> cleared:</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>c = Counter(<span class="string">&#x27;aaabbc&#x27;</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>c[<span class="string">&#x27;b&#x27;</span>] -= <span class="number">2</span>                     <span class="comment"># reduce the count of &#x27;b&#x27; by two</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>c.most_common()                 <span class="comment"># &#x27;b&#x27; is still in, but its count is zero</span></span><br><span class="line">[(<span class="string">&#x27;a&#x27;</span>, <span class="number">3</span>), (<span class="string">&#x27;c&#x27;</span>, <span class="number">1</span>), (<span class="string">&#x27;b&#x27;</span>, <span class="number">0</span>)]</span><br></pre></td></tr></table></figure>

<p><code>Counter</code>是dict的子类，可以用来计算可哈希对象的数量。它是一个无序的集合，并且元素作为dict的key，数量作为dict的value。数量可以是任意整数值，包括0和负数。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>c = Counter()                           <span class="comment"># a new, empty counter</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>Counter(<span class="string">&quot;adfadf&quot;</span>)                       <span class="comment"># a new counter from an iterables</span></span><br><span class="line">Counter(&#123;<span class="string">&#x27;a&#x27;</span>: <span class="number">2</span>, <span class="string">&#x27;d&#x27;</span>: <span class="number">2</span>, <span class="string">&#x27;f&#x27;</span>: <span class="number">2</span>&#125;)           </span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>Counter(&#123;<span class="string">&#x27;red&#x27;</span>: <span class="number">4</span>, <span class="string">&#x27;blue&#x27;</span>: <span class="number">2</span>&#125;)          <span class="comment"># a new counter from a mapping</span></span><br><span class="line">Counter(&#123;<span class="string">&#x27;red&#x27;</span>: <span class="number">4</span>, <span class="string">&#x27;blue&#x27;</span>: <span class="number">2</span>&#125;)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>Counter(cats=<span class="number">4</span>, dogs=<span class="number">8</span>)                 <span class="comment"># a new counter from keyword args</span></span><br><span class="line">Counter(&#123;<span class="string">&#x27;dogs&#x27;</span>: <span class="number">8</span>, <span class="string">&#x27;cats&#x27;</span>: <span class="number">4</span>&#125;)</span><br></pre></td></tr></table></figure>

<p>对于那些不存在的元素，如果想要获取它，Counter会返回0，而不会引发<code>KeyError</code>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>c = Counter([<span class="string">&#x27;eggs&#x27;</span>, <span class="string">&#x27;ham&#x27;</span>])</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>c[<span class="string">&#x27;bacon&#x27;</span>]                              <span class="comment"># count of a missing element is zero</span></span><br><span class="line"><span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>从源码中可以看出来为什么不引发<code>KeyError</code>:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__missing__</span>(<span class="params">self, key</span>):</span></span><br><span class="line">    <span class="string">&#x27;The count of elements not in the Counter is zero.&#x27;</span></span><br><span class="line">    <span class="comment"># Needed so that self[missing_item] does not raise KeyError</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>如果count设置为零或减少为零，它将保留在counter中，直到删除该条目或清除计数器：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>c[<span class="string">&#x27;sausage&#x27;</span>] = <span class="number">0</span>                        <span class="comment"># counter entry with a zero count</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">del</span> c[<span class="string">&#x27;sausage&#x27;</span>]  </span><br></pre></td></tr></table></figure>

<p>由于Counter是dict的子类，因此他具备dict的方法。除此之外，它还具备以下方法：</p>
<ul>
<li><p><strong>elements()</strong></p>
<p>返回每一个元素，元素会根据个数重复count次，并且是以任意顺序返回的。如果元素的个数小于1(包括负值)，那么就会被忽略不返回</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; c = Counter(a=4, b=2, c=0, d=-2)</span><br><span class="line">&gt;&gt;&gt; sorted(c.elements())</span><br><span class="line">[&#x27;a&#x27;, &#x27;a&#x27;, &#x27;a&#x27;, &#x27;a&#x27;, &#x27;b&#x27;, &#x27;b&#x27;]</span><br></pre></td></tr></table></figure></li>
<li><p><strong>most_common([n])</strong></p>
<p>返回n个最常见元素及其计数的列表，从最常见到最少。 如果省略n或None，则most_common（）返回计数器中的所有元素。 具有相同计数的元素是任意排序的：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; Counter(&#x27;abracadabra&#x27;).most_common(3)  </span><br><span class="line">[(&#x27;a&#x27;, 5), (&#x27;r&#x27;, 2), (&#x27;b&#x27;, 2)]</span><br></pre></td></tr></table></figure></li>
<li><p><strong>subtract([iterable-or-mapping])</strong></p>
<p>根据迭代器或映射中对当前元素进行加减操作。和<code>dict.update()</code>类似，但是注意，是操作，而不是替换。输入和输出可以为0或负数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; c = Counter(a=4, b=2, c=0, d=-2)</span><br><span class="line">&gt;&gt;&gt; d = Counter(a=1, b=2, c=3, d=4)</span><br><span class="line">&gt;&gt;&gt; c.subtract(d)</span><br><span class="line">&gt;&gt;&gt; c</span><br><span class="line">Counter(&#123;&#x27;a&#x27;: 3, &#x27;b&#x27;: 0, &#x27;c&#x27;: -3, &#x27;d&#x27;: -6&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<p>通常情况下，Counter对象和字典具有相同的方法。但是以下两个方法会有所不同：</p>
<ul>
<li><p><strong>fromkeys(iterable)</strong></p>
<p>Counter类没有实现这个方法</p>
</li>
<li><p><strong>update([iterable-or-mapping])</strong></p>
<p>和<code>dict.update()</code>相似，但是是进行加减操作，而不是替换。</p>
<p>从源码看，更容易理解一些：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">  def update(*args, **kwds):</span><br><span class="line">&#x27;&#x27;&#x27;Like dict.update() but add counts instead of replacing them.</span><br><span class="line"></span><br><span class="line">Source can be an iterable, a dictionary, or another Counter instance.</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; c = Counter(&#x27;which&#x27;)</span><br><span class="line">&gt;&gt;&gt; c.update(&#x27;witch&#x27;)           # add elements from another iterable</span><br><span class="line">&gt;&gt;&gt; d = Counter(&#x27;watch&#x27;)</span><br><span class="line">&gt;&gt;&gt; c.update(d)                 # add elements from another counter</span><br><span class="line">&gt;&gt;&gt; c[&#x27;h&#x27;]                      # four &#x27;h&#x27; in which, witch, and watch</span><br><span class="line">4</span><br><span class="line"></span><br><span class="line">&#x27;&#x27;&#x27;</span><br><span class="line"># The regular dict.update() operation makes no sense here because the</span><br><span class="line"># replace behavior results in the some of original untouched counts</span><br><span class="line"># being mixed-in with all of the other counts for a mismash that</span><br><span class="line"># doesn&#x27;t have a straight-forward interpretation in most counting</span><br><span class="line"># contexts.  Instead, we implement straight-addition.  Both the inputs</span><br><span class="line"># and outputs are allowed to contain zero and negative counts.</span><br><span class="line"></span><br><span class="line">if not args:</span><br><span class="line">  raise TypeError(&quot;descriptor &#x27;update&#x27; of &#x27;Counter&#x27; object &quot;</span><br><span class="line">                  &quot;needs an argument&quot;)</span><br><span class="line">self, *args = args</span><br><span class="line">if len(args) &gt; 1:</span><br><span class="line">  raise TypeError(&#x27;expected at most 1 arguments, got %d&#x27; % len(args))</span><br><span class="line">iterable = args[0] if args else None</span><br><span class="line">if iterable is not None:</span><br><span class="line">  if isinstance(iterable, _collections_abc.Mapping):</span><br><span class="line">      if self:</span><br><span class="line">          self_get = self.get</span><br><span class="line">          for elem, count in iterable.items():</span><br><span class="line">              self[elem] = count + self_get(elem, 0)</span><br><span class="line">      else:</span><br><span class="line">          super(Counter, self).update(iterable) # fast path when counter is empty</span><br><span class="line">  else:</span><br><span class="line">      _count_elements(self, iterable)</span><br><span class="line">if kwds:</span><br><span class="line">  self.update(kwds)</span><br></pre></td></tr></table></figure></li>
</ul>
<p>官网给出一些常见操作：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sum</span>(c.values())                 <span class="comment"># total of all counts</span></span><br><span class="line">c.clear()                       <span class="comment"># reset all counts</span></span><br><span class="line"><span class="built_in">list</span>(c)                         <span class="comment"># list unique elements</span></span><br><span class="line"><span class="built_in">set</span>(c)                          <span class="comment"># convert to a set</span></span><br><span class="line"><span class="built_in">dict</span>(c)                         <span class="comment"># convert to a regular dictionary</span></span><br><span class="line">c.items()                       <span class="comment"># convert to a list of (elem, cnt) pairs</span></span><br><span class="line">Counter(<span class="built_in">dict</span>(list_of_pairs))    <span class="comment"># convert from a list of (elem, cnt) pairs</span></span><br><span class="line">c.most_common()[:-n-<span class="number">1</span>:-<span class="number">1</span>]       <span class="comment"># n least common elements</span></span><br><span class="line">+c                              <span class="comment"># remove zero and negative counts</span></span><br></pre></td></tr></table></figure>

<p>提供了几个数学运算来组合Counter对象以生成多个集合（计数大于零的计数器）。 加法和减法通过添加或减去相应元素的计数来组合计数器。 &amp;和 | 返回相应计数的最小值和最大值。 每个操作都可以接受带有符号计数的输入，但输出将排除计数为零或更少的结果。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>c = Counter(a=<span class="number">3</span>, b=<span class="number">1</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d = Counter(a=<span class="number">1</span>, b=<span class="number">2</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>c + d                       <span class="comment"># add two counters together:  c[x] + d[x]</span></span><br><span class="line">Counter(&#123;<span class="string">&#x27;a&#x27;</span>: <span class="number">4</span>, <span class="string">&#x27;b&#x27;</span>: <span class="number">3</span>&#125;)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>c - d                       <span class="comment"># subtract (keeping only positive counts)</span></span><br><span class="line">Counter(&#123;<span class="string">&#x27;a&#x27;</span>: <span class="number">2</span>&#125;)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>c &amp; d                       <span class="comment"># intersection:  min(c[x], d[x]) </span></span><br><span class="line">Counter(&#123;<span class="string">&#x27;a&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;b&#x27;</span>: <span class="number">1</span>&#125;)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>c | d                       <span class="comment"># union:  max(c[x], d[x])</span></span><br><span class="line">Counter(&#123;<span class="string">&#x27;a&#x27;</span>: <span class="number">3</span>, <span class="string">&#x27;b&#x27;</span>: <span class="number">2</span>&#125;)</span><br></pre></td></tr></table></figure>

<p>一元加法和减法是用于添加空计数器或从空计数器中减去的快捷方式。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>c = Counter(a=<span class="number">2</span>, b=-<span class="number">4</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>+c</span><br><span class="line">Counter(&#123;<span class="string">&#x27;a&#x27;</span>: <span class="number">2</span>&#125;)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>-c</span><br><span class="line">Counter(&#123;<span class="string">&#x27;b&#x27;</span>: <span class="number">4</span>&#125;)</span><br></pre></td></tr></table></figure>

<p>注意 : Counter主要用于处理正整数的计数。但是也不要忘记考虑其他类型或负值的情况。Counter类继承自dict，对于key和value是没有限制的。value除了数字也可以存储其他。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://chuxiaoyi.github.io/2018/09/13/py3.7%E6%A0%87%E5%87%86%E5%BA%93-collections-ChainMap/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="chuxiaoyi">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="cxy">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/09/13/py3.7%E6%A0%87%E5%87%86%E5%BA%93-collections-ChainMap/" class="post-title-link" itemprop="url">py3.7标准库-collections-ChainMap</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-09-13 15:55:06" itemprop="dateCreated datePublished" datetime="2018-09-13T15:55:06+08:00">2018-09-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-06-10 18:16:29" itemprop="dateModified" datetime="2021-06-10T18:16:29+08:00">2021-06-10</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>2.5k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>2 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <span id="more"></span>

<h2 id="ChainMap"><a href="#ChainMap" class="headerlink" title="ChainMap"></a><strong>ChainMap</strong></h2><p><code>ChainMap</code>类提供一个快速链接多个映射（字典）的操作。通常情况下，他会比创建字典然后调用<code>update()</code>快。</p>
<p>该类可用于模拟嵌套作用域，在模板中很有用。</p>
<p>实现：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">collections</span>.<span class="title">ChainMap</span>(<span class="params">*maps</span>)</span></span><br></pre></td></tr></table></figure>

<p><code>ChainMap</code>类组合多个字典或其他映射到一个可更新的、单一的对象中。如果没有指定<code>maps</code>，就会提供一个空字典，以此来保证每个新链中都会有至少一个字典（映射）</p>
<p>底层映射存储在列表中。 该列表是公共的，可以使用<code>maps</code>属性访问或更新。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> collections <span class="keyword">import</span> ChainMap</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>m1 = &#123;<span class="string">&#x27;color&#x27;</span>: <span class="string">&#x27;red&#x27;</span>, <span class="string">&#x27;user&#x27;</span>: <span class="string">&#x27;guest&#x27;</span>&#125;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>m2 = &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;drfish&#x27;</span>, <span class="string">&#x27;age&#x27;</span>: <span class="string">&#x27;18&#x27;</span>&#125;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>chain_map = ChainMap(m1, m2)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>chain_map</span><br><span class="line">ChainMap(&#123;<span class="string">&#x27;color&#x27;</span>: <span class="string">&#x27;red&#x27;</span>, <span class="string">&#x27;user&#x27;</span>: <span class="string">&#x27;guest&#x27;</span>&#125;, &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;drfish&#x27;</span>, <span class="string">&#x27;age&#x27;</span>: <span class="string">&#x27;18&#x27;</span>&#125;)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">print</span>(chain_map.get(<span class="string">&#x27;name&#x27;</span>))</span><br><span class="line">drfish</span><br></pre></td></tr></table></figure>

<p>支持所有常用的字典方法。除此之外，还支持以下属性：</p>
<ul>
<li><p><strong>maps</strong></p>
<p>返回一个用户可以更新的映射列表。他是按照搜索顺序排序的。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; chain_map.maps</span><br><span class="line">[&#123;&#x27;color&#x27;: &#x27;red&#x27;, &#x27;user&#x27;: &#x27;guest&#x27;&#125;, &#123;&#x27;name&#x27;: &#x27;drfish&#x27;, &#x27;age&#x27;: &#x27;18&#x27;&#125;]</span><br></pre></td></tr></table></figure></li>
<li><p><strong>new_child(m=None)</strong></p>
<p>返回一个新的ChainMap，这个新ChainMap包含新添加的map，并且这个map在首位。如果没有指定m，那么就会在最前面添加一个空dict。因此<code>d.new_child()</code>相当于<code>ChainMap(&#123;&#125;, *d.maps)</code>。</p>
<p>需要注意的是，这将产生一个全新的ChainMap，和之前的互不干扰</p>
<p>读一下源码会更容易理解：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">def new_child(self, m=None):                # like Django&#x27;s Context.push()</span><br><span class="line">  &#x27;&#x27;&#x27;New ChainMap with a new map followed by all previous maps.</span><br><span class="line">  If no map is provided, an empty dict is used.</span><br><span class="line">  &#x27;&#x27;&#x27;</span><br><span class="line">  if m is None:</span><br><span class="line">      m = &#123;&#125;</span><br><span class="line">  return self.__class__(m, *self.maps)</span><br></pre></td></tr></table></figure>

<p>示例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; m3 = &#123;&#x27;data&#x27;: &#x27;1-6&#x27;&#125;</span><br><span class="line">&gt;&gt;&gt; chain_map.new_child(m=m3)</span><br><span class="line">ChainMap(&#123;&#x27;data&#x27;: &#x27;1-6&#x27;&#125;, &#123;&#x27;color&#x27;: &#x27;red&#x27;, &#x27;user&#x27;: &#x27;guest&#x27;&#125;, &#123;&#x27;name&#x27;: &#x27;drfish&#x27;, &#x27;age&#x27;: &#x27;18&#x27;&#125;)</span><br><span class="line">&gt;&gt;&gt; chain_map</span><br><span class="line">ChainMap(&#123;&#x27;color&#x27;: &#x27;red&#x27;, &#x27;user&#x27;: &#x27;guest&#x27;&#125;, &#123;&#x27;name&#x27;: &#x27;drfish&#x27;, &#x27;age&#x27;: &#x27;18&#x27;&#125;)</span><br><span class="line">&gt;&gt;&gt; id(chain_map.new_child(m=m3))</span><br><span class="line">4496700080</span><br><span class="line">&gt;&gt;&gt; id(chain_map)</span><br><span class="line">4496631176</span><br></pre></td></tr></table></figure></li>
<li><p><strong>parents</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@property</span><br><span class="line">def parents(self):                          # like Django&#x27;s Context.pop()</span><br><span class="line">  &#x27;New ChainMap from maps[1:].&#x27;</span><br><span class="line">  return self.__class__(*self.maps[1:])</span><br></pre></td></tr></table></figure>

<p>返回一个新的ChainMap，这个新ChainMap不包括第一个dict。这个对于跳过第一个map搜索很有用。<code>d.parents</code>大致相当于<code>ChainMap(*d.maps[1:])</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; chain_map.parents</span><br><span class="line">ChainMap(&#123;&#x27;name&#x27;: &#x27;drfish&#x27;, &#x27;age&#x27;: &#x27;18&#x27;&#125;)</span><br><span class="line">&gt;&gt;&gt; id(chain_map.parents)</span><br><span class="line">4492113680</span><br><span class="line">&gt;&gt;&gt; id(chain_map)</span><br><span class="line">4496631176</span><br></pre></td></tr></table></figure></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://chuxiaoyi.github.io/2018/09/10/py3.7%E6%A0%87%E5%87%86%E5%BA%93-collections-deque/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="chuxiaoyi">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="cxy">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/09/10/py3.7%E6%A0%87%E5%87%86%E5%BA%93-collections-deque/" class="post-title-link" itemprop="url">py3.7标准库-collections-deque</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-09-10 19:40:10" itemprop="dateCreated datePublished" datetime="2018-09-10T19:40:10+08:00">2018-09-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-06-10 18:16:29" itemprop="dateModified" datetime="2021-06-10T18:16:29+08:00">2021-06-10</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>4.6k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>4 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <span id="more"></span>

<h2 id="deque"><a href="#deque" class="headerlink" title="deque"></a><strong>deque</strong></h2><p>实现：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">collections</span>.<span class="title">deque</span>(<span class="params">[iterable[, maxlen]]</span>)</span></span><br></pre></td></tr></table></figure>

<p>返回一个新的deque（双端队列）对象，它初始化自<code>iterable</code>。 如果未指定iterable，则新的deque为空。</p>
<p>Deques是堆栈和队列的泛化(名称发音为“deck”，是“双端队列”的缩写)。Deques支持从deque的任意一侧线程安全、内存高效的<code>appends</code>和<code>pop</code>，在任何方向上的性能都大致相同都是O(1)。</p>
<p>尽管<code>list</code>对象支持类似的操作，但它们针对快速固定长度操作进行了优化，并导致pop(0)和insert(0，v)操作有O(n)内存移动成本，这些操作改变了底层数据表示的大小和位置。</p>
<p>如果未指定<code>maxlen</code>或为None，则deques可能会增长到任意长度。 否则，双端队列限制为指定的最大长度。 一旦有界长度双端队列已满，当添加新项时，则会从对方端丢弃相应数量的项。 有界长度deques提供类似于Unix中的<code>tail</code>过滤器的功能。 它们还可用于跟踪仅涉及最近活动的事务和其他数据池。</p>
<p>Deque对象支持以下方法：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">append(x)   <span class="comment"># 从deque的右边加入x</span></span><br><span class="line"></span><br><span class="line">appendleft(x)   <span class="comment">#从deque的左边加入x</span></span><br><span class="line"></span><br><span class="line">clear()     <span class="comment">#清除deque中的每一个元素，使其长度为0</span></span><br><span class="line"></span><br><span class="line">copy()      <span class="comment"># 创建一个deque的浅拷贝</span></span><br><span class="line"></span><br><span class="line">count(x)    <span class="comment"># deque中元素等于x的数量</span></span><br><span class="line"></span><br><span class="line">extend(iterable)    <span class="comment"># 从右侧扩展deque</span></span><br><span class="line"></span><br><span class="line">extendleft(iterable)    <span class="comment"># 从左侧扩展deque。但是，左边扩展的序列是反转iterable的顺序</span></span><br><span class="line"></span><br><span class="line">index(x[, start[, stop]])   <span class="comment"># 返回deque中的x位置（在索引开始时或索引停止之前）。返回第一个匹配的对象，如果没找到，会抛出`ValueError`</span></span><br><span class="line"></span><br><span class="line">insert(i, x)    <span class="comment"># 将x插入到deque的位置i。如果插入后导致deque超过`maxlen`，会抛出`IndexError`</span></span><br><span class="line"></span><br><span class="line">pop()   <span class="comment"># 从deque的右侧移除并返回一个元素。 如果没有元素，则会抛出IndexError。</span></span><br><span class="line"></span><br><span class="line">popleft()   <span class="comment"># 从deque的左侧移除并返回一个元素。 如果没有元素，则会抛出IndexError。</span></span><br><span class="line"></span><br><span class="line">remove(value)   <span class="comment"># 删除第一次出现的值。 如果未找到，则会抛出ValueError</span></span><br><span class="line"></span><br><span class="line">reverse()       <span class="comment"># 在原位反转deque的元素，然后返回None</span></span><br><span class="line"></span><br><span class="line">rotate(n=<span class="number">1</span>)     <span class="comment"># 向右旋转deque n步。 如果n为负数，则向左旋转。</span></span><br><span class="line">                <span class="comment"># 当双端队列不为空时，向右旋转一步相当于d.appendleft(d.pop())，向左旋转一步相当于d.append(d.popleft())。</span></span><br></pre></td></tr></table></figure>

<p>Deque对象还提供一个只读属性：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">maxlen  <span class="comment"># deque的大小，如果无界，则为None</span></span><br></pre></td></tr></table></figure>

<p>除上述之外，deques支持迭代，pickling, len(d), reverse(d), copy.copy(d), copy.deepcopy(d), 使用<code>in</code>运算符进行成员资格测试，以及下标引用，例如d[-1]。 索引访问在两端都是O(1), 但在中间减慢到O(n)。 对于快速随机访问，请改用list。</p>
<p>栗子：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> collections <span class="keyword">import</span> deque</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d = deque(<span class="string">&#x27;ghi&#x27;</span>)                 <span class="comment"># make a new deque with three items</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">for</span> elem <span class="keyword">in</span> d:                   <span class="comment"># iterate over the deque&#x27;s elements</span></span><br><span class="line"><span class="meta">... </span>    <span class="built_in">print</span>(elem.upper())</span><br><span class="line">G</span><br><span class="line">H</span><br><span class="line">I</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d.append(<span class="string">&#x27;j&#x27;</span>)                    <span class="comment"># add a new entry to the right side</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d.appendleft(<span class="string">&#x27;f&#x27;</span>)                <span class="comment"># add a new entry to the left side</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d                                <span class="comment"># show the representation of the deque</span></span><br><span class="line">deque([<span class="string">&#x27;f&#x27;</span>, <span class="string">&#x27;g&#x27;</span>, <span class="string">&#x27;h&#x27;</span>, <span class="string">&#x27;i&#x27;</span>, <span class="string">&#x27;j&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d.pop()                          <span class="comment"># return and remove the rightmost item</span></span><br><span class="line"><span class="string">&#x27;j&#x27;</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d.popleft()                      <span class="comment"># return and remove the leftmost item</span></span><br><span class="line"><span class="string">&#x27;f&#x27;</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">list</span>(d)                          <span class="comment"># list the contents of the deque</span></span><br><span class="line">[<span class="string">&#x27;g&#x27;</span>, <span class="string">&#x27;h&#x27;</span>, <span class="string">&#x27;i&#x27;</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d[<span class="number">0</span>]                             <span class="comment"># peek at leftmost item</span></span><br><span class="line"><span class="string">&#x27;g&#x27;</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d[-<span class="number">1</span>]                            <span class="comment"># peek at rightmost item</span></span><br><span class="line"><span class="string">&#x27;i&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">list</span>(<span class="built_in">reversed</span>(d))                <span class="comment"># list the contents of a deque in reverse</span></span><br><span class="line">[<span class="string">&#x27;i&#x27;</span>, <span class="string">&#x27;h&#x27;</span>, <span class="string">&#x27;g&#x27;</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">&#x27;h&#x27;</span> <span class="keyword">in</span> d                         <span class="comment"># search the deque</span></span><br><span class="line"><span class="literal">True</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d.extend(<span class="string">&#x27;jkl&#x27;</span>)                  <span class="comment"># add multiple elements at once</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d</span><br><span class="line">deque([<span class="string">&#x27;g&#x27;</span>, <span class="string">&#x27;h&#x27;</span>, <span class="string">&#x27;i&#x27;</span>, <span class="string">&#x27;j&#x27;</span>, <span class="string">&#x27;k&#x27;</span>, <span class="string">&#x27;l&#x27;</span>])</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d.rotate(<span class="number">1</span>)                      <span class="comment"># right rotation</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d</span><br><span class="line">deque([<span class="string">&#x27;l&#x27;</span>, <span class="string">&#x27;g&#x27;</span>, <span class="string">&#x27;h&#x27;</span>, <span class="string">&#x27;i&#x27;</span>, <span class="string">&#x27;j&#x27;</span>, <span class="string">&#x27;k&#x27;</span>])</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d.rotate(-<span class="number">1</span>)                     <span class="comment"># left rotation</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d</span><br><span class="line">deque([<span class="string">&#x27;g&#x27;</span>, <span class="string">&#x27;h&#x27;</span>, <span class="string">&#x27;i&#x27;</span>, <span class="string">&#x27;j&#x27;</span>, <span class="string">&#x27;k&#x27;</span>, <span class="string">&#x27;l&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>deque(<span class="built_in">reversed</span>(d))               <span class="comment"># make a new deque in reverse order</span></span><br><span class="line">deque([<span class="string">&#x27;l&#x27;</span>, <span class="string">&#x27;k&#x27;</span>, <span class="string">&#x27;j&#x27;</span>, <span class="string">&#x27;i&#x27;</span>, <span class="string">&#x27;h&#x27;</span>, <span class="string">&#x27;g&#x27;</span>])</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d.clear()                        <span class="comment"># empty the deque</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d.pop()                          <span class="comment"># cannot pop from an empty deque</span></span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">    File <span class="string">&quot;&lt;pyshell#6&gt;&quot;</span>, line <span class="number">1</span>, <span class="keyword">in</span> -toplevel-</span><br><span class="line">        d.pop()</span><br><span class="line">IndexError: pop <span class="keyword">from</span> an empty deque</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d.extendleft(<span class="string">&#x27;abc&#x27;</span>)              <span class="comment"># extendleft() reverses the input order</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d</span><br><span class="line">deque([<span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;a&#x27;</span>])</span><br></pre></td></tr></table></figure>

<p>接下来，介绍一些deque的使用方法</p>
<p>有界长度deques提供类似于Unix中的<code>tail</code>过滤器的功能：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">tail</span>(<span class="params">filename, n=<span class="number">10</span></span>):</span></span><br><span class="line">    <span class="string">&#x27;Return the last n lines of a file&#x27;</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(filename) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">return</span> deque(f, n)</span><br></pre></td></tr></table></figure>

<p>使用deques的另一种方法是通过向右追加并弹出到左侧来维护一系列最近添加的元素：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> deque</span><br><span class="line"><span class="keyword">import</span> itertools</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">moving_average</span>(<span class="params">iterable, n=<span class="number">3</span></span>):</span></span><br><span class="line">    <span class="comment"># moving_average([40, 30, 50, 46, 39, 44]) --&gt; 40.0 42.0 45.0 43.0</span></span><br><span class="line">    <span class="comment"># http://en.wikipedia.org/wiki/Moving_average</span></span><br><span class="line">    it = <span class="built_in">iter</span>(iterable)</span><br><span class="line">    d = deque(itertools.islice(it, n-<span class="number">1</span>))</span><br><span class="line">    d.appendleft(<span class="number">0</span>)</span><br><span class="line">    s = <span class="built_in">sum</span>(d)</span><br><span class="line">    <span class="keyword">for</span> elem <span class="keyword">in</span> it:</span><br><span class="line">        s += elem - d.popleft()</span><br><span class="line">        d.append(elem)</span><br><span class="line">        <span class="keyword">yield</span> s / n</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> moving_average([<span class="number">40</span>, <span class="number">30</span>, <span class="number">50</span>, <span class="number">46</span>, <span class="number">39</span>, <span class="number">44</span>]):</span><br><span class="line">        <span class="built_in">print</span>(i)</span><br><span class="line"></span><br><span class="line">结果：</span><br><span class="line"><span class="number">40.0</span></span><br><span class="line"><span class="number">42.0</span></span><br><span class="line"><span class="number">45.0</span></span><br><span class="line"><span class="number">43.0</span></span><br></pre></td></tr></table></figure>

<p>可以使用存储在双端队列中的输入迭代器来实现循环调度程序。 值从位置零处的活动迭代器产生。 如果该迭代器耗尽，可以使用popleft()删除它; 否则，它可以使用rotate()方法循环回到最后：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">roundrobin</span>(<span class="params">*iterables</span>):</span></span><br><span class="line">    <span class="string">&quot;roundrobin(&#x27;ABC&#x27;, &#x27;D&#x27;, &#x27;EF&#x27;) --&gt; A D E B F C&quot;</span></span><br><span class="line">    iterators = deque(<span class="built_in">map</span>(<span class="built_in">iter</span>, iterables))</span><br><span class="line">    <span class="keyword">while</span> iterators:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">                <span class="keyword">yield</span> <span class="built_in">next</span>(iterators[<span class="number">0</span>])</span><br><span class="line">                iterators.rotate(-<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">except</span> StopIteration:</span><br><span class="line">            <span class="comment"># Remove an exhausted iterator.</span></span><br><span class="line">            iterators.popleft()</span><br></pre></td></tr></table></figure>

<p><code>rotate()</code>方法提供了一种实现双端切片和删除的方法。 例如，<code>del d[n]</code>的纯Python实现依赖于<code>rotate()</code>方法来定位要弹出的元素：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete_nth</span>(<span class="params">d, n</span>):</span></span><br><span class="line">    d.rotate(-n)</span><br><span class="line">    d.popleft()</span><br><span class="line">    d.rotate(n)</span><br></pre></td></tr></table></figure>

<p>要实现双端切片，请使用类似的方法应用<code>rotate()</code>将目标元素置于双端队列的左侧。 使用<code>popleft()</code>删除旧条目，使用<code>extend()</code>添加新条目，然后反转旋转。 通过该方法的微小变化，可以轻松实现Forth样式堆栈操作，例如dup，drop，swap，over，pick，rot和roll。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://chuxiaoyi.github.io/2018/09/10/py3.7%E6%A0%87%E5%87%86%E5%BA%93-collections-namedtuple/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="chuxiaoyi">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="cxy">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/09/10/py3.7%E6%A0%87%E5%87%86%E5%BA%93-collections-namedtuple/" class="post-title-link" itemprop="url">py3.7标准库-collections-namedtuple</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-09-10 12:12:04" itemprop="dateCreated datePublished" datetime="2018-09-10T12:12:04+08:00">2018-09-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-06-10 18:16:29" itemprop="dateModified" datetime="2021-06-10T18:16:29+08:00">2021-06-10</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>4.7k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>4 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <span id="more"></span>

<p>collection模块实现了专门的容器数据类型，为Python的通用内置容器<code>dict</code>，<code>list</code>，<code>set</code>和<code>tuple</code>提供了替代方案。接下来，将分别介绍他们。</p>
<h2 id="namedtuple"><a href="#namedtuple" class="headerlink" title="namedtuple()"></a><strong>namedtuple()</strong></h2><p>包含命名字段的元组工厂方法<br>命名元组为元组中的每个位置赋予含义，并允许更可读，自文档代码。<br>它们可以在使用常规元组的任何地方使用，并且它们添加了按名称而不是位置索引访问字段的功能。</p>
<p>实现：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">collections.namedtuple(typename, field_names, *, rename=<span class="literal">False</span>, defaults=<span class="literal">None</span>, module=<span class="literal">None</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li><p>返回一个名为<code>typename</code>的新元组子类。 新子类用于创建类似元组的对象，这些对象具有可通过属性查找访问的字段以及可索引和可迭代的字段。 子类的实例还有一个有用的文档字符串（带有<code>typename</code>和<code>field_names</code>）和一个有用的<code>__repr __()</code>方法，它以<code>name = value</code>格式列出元组内容。</p>
</li>
<li><p><code>field_names</code>是一系列字符串，例如<code>[&#39;x&#39;，&#39;y&#39;]</code>。 或者，<code>field_names</code>可以是单个字符串，每个字段名由<code>空格</code>和<code>/</code>或<code>逗号</code>分隔，例如<code>&#39;x y&#39;</code>或<code>&#39;x，y&#39;</code>。</p>
</li>
<li><p>除了以下划线开头的名称外，任何有效的Python标识符都可用于字段名。有效标识符由字母，数字和下划线组成，但不以数字或下划线开头，也不能是类，for，return，global，pass或raise等关键字。</p>
</li>
<li><p>如果<code>rename</code>为<code>true</code>，则无效的字段名称将自动替换为位置名称。 例如，<code>[&#39;abc&#39;，&#39;def&#39;，&#39;ghi&#39;，&#39;abc&#39;]</code>被转换为<code>[&#39;abc&#39;，&#39;_1&#39;，&#39;ghi&#39;，&#39;_3&#39;]</code>，消除了关键字<code>def</code>和重复的字段名<code>abc</code>。</p>
</li>
<li><p><code>defaults</code>可以是None或可迭代的默认值。 由于具有默认值的字段必须位于没有默认值的任何字段之后，因此默认值将应用于最右侧的参数。 例如，如果字段名是[‘x’，’y’，’z’]并且默认值是（1,2），则x将是必需参数，y将默认为1，z将默认为2。</p>
</li>
<li><p>如果定义了<code>module</code>，则将命名元组的<code>__module__</code>属性设置为该值。</p>
</li>
<li><p>命名的元组实例没有每个实例的字典，因此它们是轻量级的，并且不需要比常规元组更多的内存。</p>
</li>
</ul>
<p>举个例子：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="comment"># Basic example</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>Point = namedtuple(<span class="string">&#x27;Point&#x27;</span>, [<span class="string">&#x27;x&#x27;</span>, <span class="string">&#x27;y&#x27;</span>])</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>p = Point(<span class="number">11</span>, y=<span class="number">22</span>)     <span class="comment"># instantiate with positional or keyword arguments</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>p[<span class="number">0</span>] + p[<span class="number">1</span>]             <span class="comment"># indexable like the plain tuple (11, 22)</span></span><br><span class="line"><span class="number">33</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>x, y = p                <span class="comment"># unpack like a regular tuple</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>x, y</span><br><span class="line">(<span class="number">11</span>, <span class="number">22</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>p.x + p.y               <span class="comment"># fields also accessible by name</span></span><br><span class="line"><span class="number">33</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>p                       <span class="comment"># readable __repr__ with a name=value style</span></span><br><span class="line">Point(x=<span class="number">11</span>, y=<span class="number">22</span>)</span><br></pre></td></tr></table></figure>

<p>命名元组对于将字段名称分配给csv或sqlite3模块返回的结果元组特别有用：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">EmployeeRecord = namedtuple(<span class="string">&#x27;EmployeeRecord&#x27;</span>, <span class="string">&#x27;name, age, title, department, paygrade&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> csv</span><br><span class="line"><span class="keyword">for</span> emp <span class="keyword">in</span> <span class="built_in">map</span>(EmployeeRecord._make, csv.reader(<span class="built_in">open</span>(<span class="string">&quot;employees.csv&quot;</span>, <span class="string">&quot;rb&quot;</span>))):</span><br><span class="line">    <span class="built_in">print</span>(emp.name, emp.title)</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sqlite3</span><br><span class="line">conn = sqlite3.connect(<span class="string">&#x27;/companydata&#x27;</span>)</span><br><span class="line">cursor = conn.cursor()</span><br><span class="line">cursor.execute(<span class="string">&#x27;SELECT name, age, title, department, paygrade FROM employees&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> emp <span class="keyword">in</span> <span class="built_in">map</span>(EmployeeRecord._make, cursor.fetchall()):</span><br><span class="line">    <span class="built_in">print</span>(emp.name, emp.title)</span><br></pre></td></tr></table></figure>

<p>除了从元组继承的方法之外，命名元组还支持三个额外的方法和两个属性。 为防止与字段名称冲突，方法和属性名称以下划线开头。</p>
<ul>
<li><p><strong>classmethod somenamedtuple._make(iterable)</strong></p>
<p>从现有序列或可迭代对象生成新的实例</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; t = [11, 22]</span><br><span class="line">&gt;&gt;&gt; Point._make(t)</span><br><span class="line">Point(x=11, y=22)</span><br></pre></td></tr></table></figure></li>
<li><p><strong>somenamedtuple._asdict()</strong></p>
<p>返回一个新的OrderedDict，它将字段名称映射到它们对应的值：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; p = Point(x=11, y=22)</span><br><span class="line">&gt;&gt;&gt; p._asdict()</span><br><span class="line">OrderedDict([(&#x27;x&#x27;, 11), (&#x27;y&#x27;, 22)])</span><br></pre></td></tr></table></figure></li>
<li><p><strong>somenamedtuple._replace(**kwargs)</strong></p>
<p>返回namedtuple的新实例，用新值替换特定字段：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; p = Point(x=11, y=22)</span><br><span class="line">&gt;&gt;&gt; p._replace(x=33)</span><br><span class="line">Point(x=33, y=22)</span><br><span class="line">&gt;&gt;&gt;id(p._replace(x=66))</span><br><span class="line">4572244008</span><br><span class="line">&gt;&gt;&gt;id(p)</span><br><span class="line">4569821544</span><br></pre></td></tr></table></figure></li>
<li><p><strong>somenamedtuple._fields</strong></p>
<p>列出字段名称的字符串元组。 用于内省和从现有命名元组创建新的命名元组类型。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt;p._fields            # view the field names</span><br><span class="line">(&#x27;x&#x27;, &#x27;y&#x27;)</span><br><span class="line">&gt;&gt;&gt; Color = namedtuple(&#x27;Color&#x27;, &#x27;red green blue&#x27;)</span><br><span class="line">&gt;&gt;&gt; Pixel = namedtuple(&#x27;Pixel&#x27;, Point._fields + Color._fields)</span><br><span class="line">&gt;&gt;&gt; Pixel(11, 22, 128, 255, 0)</span><br><span class="line">Pixel(x=11, y=22, red=128, green=255, blue=0)</span><br></pre></td></tr></table></figure></li>
<li><p><strong>somenamedtuple._fields_defaults</strong></p>
<p>字典将字段名称映射到默认值。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; Account = namedtuple(&#x27;Account&#x27;, [&#x27;type&#x27;, &#x27;balance&#x27;], defaults=[0])</span><br><span class="line">&gt;&gt;&gt; Account._fields_defaults</span><br><span class="line">&#123;&#x27;balance&#x27;: 0&#125;</span><br><span class="line">&gt;&gt;&gt; Account(&#x27;premium&#x27;)</span><br><span class="line">Account(type=&#x27;premium&#x27;, balance=0)</span><br></pre></td></tr></table></figure></li>
</ul>
<p>要检索一个对象的字段，使用<code>getattr()</code>方法：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">getattr</span>(p, <span class="string">&#x27;x&#x27;</span>)</span><br><span class="line"><span class="number">11</span></span><br></pre></td></tr></table></figure>

<p>要将字典转化为一个命名元组，使用<code>**x</code>的方式赋值:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>d = &#123;<span class="string">&#x27;x&#x27;</span>: <span class="number">11</span>, <span class="string">&#x27;y&#x27;</span>: <span class="number">22</span>&#125;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>Point(**d)</span><br><span class="line">Point(x=<span class="number">11</span>, y=<span class="number">22</span>)</span><br></pre></td></tr></table></figure>

<p>由于命名元组是常规Python类，因此很容易使用子类添加或更改功能。 以下是添加计算字段和固定宽度打印格式的方法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; class Point(namedtuple(&#x27;Point&#x27;, [&#x27;x&#x27;, &#x27;y&#x27;])):</span><br><span class="line">...     __slots__ = ()</span><br><span class="line">...     @property</span><br><span class="line">...     def hypot(self):</span><br><span class="line">...         return (self.x ** 2 + self.y ** 2) ** 0.5</span><br><span class="line">...     def __str__(self):</span><br><span class="line">...         return &#x27;Point: x=%6.3f  y=%6.3f  hypot=%6.3f&#x27; % (self.x, self.y, self.hypot)</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; for p in Point(3, 4), Point(14, 5/7):</span><br><span class="line">...     print(p)</span><br><span class="line">Point: x= 3.000  y= 4.000  hypot= 5.000</span><br><span class="line">Point: x=14.000  y= 0.714  hypot=14.018</span><br></pre></td></tr></table></figure>

<p>上面显示的子类将<strong>slots</strong>设置为空元组。 这有助于防止创建实例字典，从而降低内存需求。</p>
<p>子类化对于添加新的存储字段没有用。 相反，只需从_fields属性创建一个新的命名元组类型：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; Point3D = namedtuple(&#x27;Point3D&#x27;, Point._fields + (&#x27;z&#x27;,))</span><br></pre></td></tr></table></figure>

<p>可以通过直接分配<code>__doc__</code>字段来自定义文档字符串：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; Book = namedtuple(&#x27;Book&#x27;, [&#x27;id&#x27;, &#x27;title&#x27;, &#x27;authors&#x27;])</span><br><span class="line">&gt;&gt;&gt; Book.__doc__ += &#x27;: Hardcover book in active collection&#x27;</span><br><span class="line">&gt;&gt;&gt; Book.id.__doc__ = &#x27;13-digit ISBN&#x27;</span><br><span class="line">&gt;&gt;&gt; Book.title.__doc__ = &#x27;Title of first printing&#x27;</span><br><span class="line">&gt;&gt;&gt; Book.authors.__doc__ = &#x27;List of authors sorted by last name&#x27;</span><br></pre></td></tr></table></figure>

<p>通过使用<code>_replace()</code>对定制的已经有默认值的原型实例进行改造</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; Account = namedtuple(&#x27;Account&#x27;, &#x27;owner balance transaction_count&#x27;)</span><br><span class="line">&gt;&gt;&gt; default_account = Account(&#x27;&lt;owner name&gt;&#x27;, 0.0, 0)</span><br><span class="line">&gt;&gt;&gt; johns_account = default_account._replace(owner=&#x27;John&#x27;)</span><br><span class="line">&gt;&gt;&gt; janes_account = default_account._replace(owner=&#x27;Jane&#x27;)</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://chuxiaoyi.github.io/2018/09/07/py3.7%E6%A0%87%E5%87%86%E5%BA%93-itertools/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="chuxiaoyi">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="cxy">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/09/07/py3.7%E6%A0%87%E5%87%86%E5%BA%93-itertools/" class="post-title-link" itemprop="url">py3.7标准库-itertools</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-09-07 16:47:06" itemprop="dateCreated datePublished" datetime="2018-09-07T16:47:06+08:00">2018-09-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-06-10 18:16:29" itemprop="dateModified" datetime="2021-06-10T18:16:29+08:00">2021-06-10</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/python3-7%E6%A0%87%E5%87%86%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">python3.7标准库</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>9.5k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>9 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <span id="more"></span>

<p>Python的内建模块itertools提供了非常有用的用于操作迭代对象的函数。</p>
<h3 id="itertools-count-start-0-step-1"><a href="#itertools-count-start-0-step-1" class="headerlink" title="itertools.count(start=0, step=1)"></a><strong>itertools.count(start=0, step=1)</strong></h3><p>创建一个迭代器，生成从n开始的连续整数，如果忽略n，则从0开始计算（注意：此迭代器不支持长整数)</p>
<p>如果超出了sys.maxint，计数器将溢出并继续从-sys.maxint-1开始计算。</p>
<p>当使用浮点数进行计数时，有时可以通过替换乘法代码来实现更高的准确率，例如：<code>(start + step * i for i in count())</code></p>
<p>该方法等价于：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">count</span>(<span class="params">start=<span class="number">0</span>, step=<span class="number">1</span></span>):</span></span><br><span class="line">    <span class="comment"># count(10) --&gt; 10 11 12 13 14 ...</span></span><br><span class="line">    <span class="comment"># count(2.5, 0.5) -&gt; 2.5 3.0 3.5 ...</span></span><br><span class="line">    n = start</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">yield</span> n</span><br><span class="line">        n += step</span><br></pre></td></tr></table></figure>

<h3 id="itertools-cycle-iterable"><a href="#itertools-cycle-iterable" class="headerlink" title="itertools.cycle(iterable)"></a><strong>itertools.cycle(iterable)</strong></h3><p>创造一个迭代器，复制从当前迭代器返回的每一个元素并将其保存到创建的迭代器中。当当前迭代器耗尽时，从创造的迭代器循环返回元素。</p>
<p>简单理解就是，传入一个序列，无限循环下去</p>
<p>大致相当于:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cycle</span>(<span class="params">iterable</span>):</span></span><br><span class="line">    <span class="comment"># cycle(&#x27;ABCD&#x27;) --&gt; A B C D A B C D A B C D ...</span></span><br><span class="line">    saved = []</span><br><span class="line">    <span class="keyword">for</span> element <span class="keyword">in</span> iterable:</span><br><span class="line">        <span class="keyword">yield</span> element</span><br><span class="line">        saved.append(element)</span><br><span class="line">    <span class="keyword">while</span> saved:</span><br><span class="line">        <span class="keyword">for</span> element <span class="keyword">in</span> saved:</span><br><span class="line">              <span class="keyword">yield</span> element</span><br></pre></td></tr></table></figure>

<h3 id="itertools-repeat-object-times"><a href="#itertools-repeat-object-times" class="headerlink" title="itertools.repeat(object[, times])"></a><strong>itertools.repeat(object[, times])</strong></h3><p>让迭代器一次又一次地返回对象。无限运行，除非指定了<code>times</code>参数控制重复次数</p>
<p>大致相当于：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">repeat</span>(<span class="params"><span class="built_in">object</span>, times=<span class="literal">None</span></span>):</span></span><br><span class="line">    <span class="comment"># repeat(10, 3) --&gt; 10 10 10</span></span><br><span class="line">    <span class="keyword">if</span> times <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="keyword">yield</span> <span class="built_in">object</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(times):</span><br><span class="line">            <span class="keyword">yield</span> <span class="built_in">object</span></span><br></pre></td></tr></table></figure>

<p>repeat的一个常见用法是提供一个用于map或zip的常数流:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; list(map(pow, range(10), repeat(2)))</span><br><span class="line">[0, 1, 4, 9, 16, 25, 36, 49, 64, 81]</span><br></pre></td></tr></table></figure>

<h3 id="itertools-accumulate-iterable-func"><a href="#itertools-accumulate-iterable-func" class="headerlink" title="itertools.accumulate(iterable[, func])"></a><strong>itertools.accumulate(iterable[, func])</strong></h3><p>创建一个迭代器，它返回计算的累积和，或其他二进制函数的计算结果（这个二进制函数可以通过func参数指定）。如果指定了func参数，必须保证这个参数对应的函数可以接收两个参数。</p>
<p>大致相当于：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">accumulate</span>(<span class="params">iterable, func=operator.add</span>):</span></span><br><span class="line">    <span class="string">&#x27;Return running totals&#x27;</span></span><br><span class="line">    <span class="comment"># accumulate([1,2,3,4,5]) --&gt; 1 3 6 10 15</span></span><br><span class="line">    <span class="comment"># accumulate([1,2,3,4,5], operator.mul) --&gt; 1 2 6 24 120</span></span><br><span class="line">    it = <span class="built_in">iter</span>(iterable)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        total = <span class="built_in">next</span>(it)</span><br><span class="line">    <span class="keyword">except</span> StopIteration:</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">yield</span> total</span><br><span class="line">    <span class="keyword">for</span> element <span class="keyword">in</span> it:</span><br><span class="line">        total = func(total, element)</span><br><span class="line">        <span class="keyword">yield</span> total</span><br></pre></td></tr></table></figure>

<p>如果很难理解，可以这样理解：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">对于默认func来说，结果就是[p0, p0+p1, p0+p1+p2, …]</span><br></pre></td></tr></table></figure>

<h3 id="itertools-chain-iterables"><a href="#itertools-chain-iterables" class="headerlink" title="itertools.chain(*iterables)"></a><strong>itertools.chain(*iterables)</strong></h3><p>创建一个迭代器，该迭代器从第一个迭代返回元素，直到它被耗尽，然后继续到下一个迭代，直到所有的迭代都被耗尽。用于将连续序列视为单个序列。<br>大致相当于:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">chain</span>(<span class="params">*iterables</span>):</span></span><br><span class="line">    <span class="comment"># chain(&#x27;ABC&#x27;, &#x27;DEF&#x27;) --&gt; A B C D E F</span></span><br><span class="line">    <span class="keyword">for</span> it <span class="keyword">in</span> iterables:</span><br><span class="line">        <span class="keyword">for</span> element <span class="keyword">in</span> it:</span><br><span class="line">            <span class="keyword">yield</span> element</span><br></pre></td></tr></table></figure>

<h3 id="classmethod-chain-from-iterable-iterable"><a href="#classmethod-chain-from-iterable-iterable" class="headerlink" title="classmethod chain.from_iterable(iterable)"></a><strong>classmethod chain.from_iterable(iterable)</strong></h3><p>改变<code>chain()</code>的结构，从一个懒加载的可迭代对象中获取输入值。大致相当于：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">from_iterable</span>(<span class="params">iterables</span>):</span></span><br><span class="line">    <span class="comment"># chain.from_iterable([&#x27;ABC&#x27;, &#x27;DEF&#x27;]) --&gt; A B C D E F</span></span><br><span class="line">    <span class="keyword">for</span> it <span class="keyword">in</span> iterables:</span><br><span class="line">        <span class="keyword">for</span> element <span class="keyword">in</span> it:</span><br><span class="line">            <span class="keyword">yield</span> element</span><br></pre></td></tr></table></figure>

<h3 id="itertools-compress-data-selectors"><a href="#itertools-compress-data-selectors" class="headerlink" title="itertools.compress(data, selectors)"></a><strong>itertools.compress(data, selectors)</strong></h3><p>过滤迭代器中的元素，只返回在selectors中计算为<code>True</code>的对应元素。当迭代器或选择器结束后，就停止。<br>大致相当于：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">compress</span>(<span class="params">data, selectors</span>):</span></span><br><span class="line">    <span class="comment"># compress(&#x27;ABCDEF&#x27;, [1,0,1,0,1,1]) --&gt; A C E F</span></span><br><span class="line">    <span class="keyword">return</span> (d <span class="keyword">for</span> d, s <span class="keyword">in</span> <span class="built_in">zip</span>(data, selectors) <span class="keyword">if</span> s)</span><br></pre></td></tr></table></figure>

<h3 id="itertools-dropwhile-predicate-iterable"><a href="#itertools-dropwhile-predicate-iterable" class="headerlink" title="itertools.dropwhile(predicate, iterable)"></a><strong>itertools.dropwhile(predicate, iterable)</strong></h3><p>去除predicate为true的元素，当第一次遇到predicate为false的情况时，直接将其与后面的全都一起返回<br>大致相当于：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dropwhile</span>(<span class="params">predicate, iterable</span>):</span></span><br><span class="line">    <span class="comment"># dropwhile(lambda x: x&lt;5, [1,4,6,4,1]) --&gt; 6 4 1</span></span><br><span class="line">    iterable = <span class="built_in">iter</span>(iterable)</span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> iterable:</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> predicate(x):</span><br><span class="line">            <span class="keyword">yield</span> x</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> iterable:</span><br><span class="line">        <span class="keyword">yield</span> x</span><br></pre></td></tr></table></figure>

<h3 id="itertools-filterfalse-predicate-iterable"><a href="#itertools-filterfalse-predicate-iterable" class="headerlink" title="itertools.filterfalse(predicate, iterable)"></a><strong>itertools.filterfalse(predicate, iterable)</strong></h3><p>从迭代器中过滤出所有使predicate为<code>False</code>的元素，并返回<br>大致相当于：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">filterfalse</span>(<span class="params">predicate, iterable</span>):</span></span><br><span class="line">    <span class="comment"># filterfalse(lambda x: x%2, range(10)) --&gt; 0 2 4 6 8</span></span><br><span class="line">    <span class="keyword">if</span> predicate <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        predicate = <span class="built_in">bool</span></span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> iterable:</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> predicate(x):</span><br><span class="line">            <span class="keyword">yield</span> x</span><br></pre></td></tr></table></figure>

<h3 id="itertools-groupby-iterable-key-None"><a href="#itertools-groupby-iterable-key-None" class="headerlink" title="itertools.groupby(iterable, key=None)"></a><strong>itertools.groupby(iterable, key=None)</strong></h3><p>创建一个从迭代中返回连续键和组的迭代器。 关键是计算每个元素的键值的函数。 如果未指定或为None，则键默认为标识函数并返回元素不变。 通常，迭代需要在相同的键函数上排序。</p>
<p>groupby（）的操作类似于Unix中的uniq过滤器。 每次键函数的值发生变化时，它都会生成一个中断或新组（这就是为什么通常需要使用相同的键函数对数据进行排序）。 这种行为不同于SQL的GROUP BY，它聚合了常见元素而不管它们的输入顺序如何。</p>
<p>返回的组本身是一个迭代器，它与groupby（）共享底层的iterable。 由于源是共享的，因此当groupby（）对象被迭代时，前一个组被迭代的将不再可见。 因此，如果以后需要该数据，则应将其存储为列表：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">groups = []</span><br><span class="line">uniquekeys = []</span><br><span class="line">data = <span class="built_in">sorted</span>(data, key=keyfunc)</span><br><span class="line"><span class="keyword">for</span> k, g <span class="keyword">in</span> groupby(data, keyfunc):</span><br><span class="line">    groups.append(<span class="built_in">list</span>(g))      <span class="comment"># Store group iterator as a list</span></span><br><span class="line">    uniquekeys.append(k)</span><br></pre></td></tr></table></figure>

<p><code>groupby()</code>相当于：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">groupby</span>:</span></span><br><span class="line">    <span class="comment"># [k for k, g in groupby(&#x27;AAAABBBCCDAABBB&#x27;)] --&gt; A B C D A B</span></span><br><span class="line">    <span class="comment"># [list(g) for k, g in groupby(&#x27;AAAABBBCCD&#x27;)] --&gt; AAAA BBB CC D</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, iterable, key=<span class="literal">None</span></span>):</span></span><br><span class="line">        <span class="keyword">if</span> key <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            key = <span class="keyword">lambda</span> x: x</span><br><span class="line">        self.keyfunc = key</span><br><span class="line">        self.it = <span class="built_in">iter</span>(iterable)</span><br><span class="line">        self.tgtkey = self.currkey = self.currvalue = <span class="built_in">object</span>()</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__iter__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__next__</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.<span class="built_in">id</span> = <span class="built_in">object</span>()</span><br><span class="line">        <span class="keyword">while</span> self.currkey == self.tgtkey:</span><br><span class="line">            self.currvalue = <span class="built_in">next</span>(self.it)    <span class="comment"># Exit on StopIteration</span></span><br><span class="line">            self.currkey = self.keyfunc(self.currvalue)</span><br><span class="line">        self.tgtkey = self.currkey</span><br><span class="line">        <span class="keyword">return</span> (self.currkey, self._grouper(self.tgtkey, self.<span class="built_in">id</span>))</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_grouper</span>(<span class="params">self, tgtkey, <span class="built_in">id</span></span>):</span></span><br><span class="line">        <span class="keyword">while</span> self.<span class="built_in">id</span> <span class="keyword">is</span> <span class="built_in">id</span> <span class="keyword">and</span> self.currkey == tgtkey:</span><br><span class="line">            <span class="keyword">yield</span> self.currvalue</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                self.currvalue = <span class="built_in">next</span>(self.it)</span><br><span class="line">            <span class="keyword">except</span> StopIteration:</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            self.currkey = self.keyfunc(self.currvalue)</span><br></pre></td></tr></table></figure>

<p>举个例子：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> groupby</span><br><span class="line">qs = [&#123;<span class="string">&#x27;date&#x27;</span> : <span class="number">1</span>&#125;,&#123;<span class="string">&#x27;date&#x27;</span> : <span class="number">2</span>&#125;]</span><br><span class="line">[(name, <span class="built_in">list</span>(group)) <span class="keyword">for</span> name, group <span class="keyword">in</span> itertools.groupby(qs, <span class="keyword">lambda</span> p:p[<span class="string">&#x27;date&#x27;</span>])]</span><br><span class="line"></span><br><span class="line">Out[<span class="number">77</span>]: [(<span class="number">1</span>, [&#123;<span class="string">&#x27;date&#x27;</span>: <span class="number">1</span>&#125;]), (<span class="number">2</span>, [&#123;<span class="string">&#x27;date&#x27;</span>: <span class="number">2</span>&#125;])]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> itertools <span class="keyword">import</span> *</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a = [<span class="string">&#x27;aa&#x27;</span>, <span class="string">&#x27;ab&#x27;</span>, <span class="string">&#x27;abc&#x27;</span>, <span class="string">&#x27;bcd&#x27;</span>, <span class="string">&#x27;abcde&#x27;</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">for</span> i, k <span class="keyword">in</span> groupby(a, <span class="built_in">len</span>):</span><br><span class="line"><span class="meta">... </span>    <span class="built_in">print</span> i, <span class="built_in">list</span>(k)</span><br><span class="line">...</span><br><span class="line"><span class="number">2</span> [<span class="string">&#x27;aa&#x27;</span>, <span class="string">&#x27;ab&#x27;</span>]</span><br><span class="line"><span class="number">3</span> [<span class="string">&#x27;abc&#x27;</span>, <span class="string">&#x27;bcd&#x27;</span>]</span><br><span class="line"><span class="number">5</span> [<span class="string">&#x27;abcde&#x27;</span>]</span><br></pre></td></tr></table></figure>

<h3 id="itertools-islice-iterable-start-stop-step-和itertools-islice-iterable-stop"><a href="#itertools-islice-iterable-start-stop-step-和itertools-islice-iterable-stop" class="headerlink" title="itertools.islice(iterable, start, stop[, step])和itertools.islice(iterable, stop)"></a><strong>itertools.islice(iterable, start, stop[, step])<strong>和</strong>itertools.islice(iterable, stop)</strong></h3><p>创建一个迭代器，该迭代器从iterable返回选中的元素。如果start是非零的，则跳过可迭代的元素，直到到达start为止。之后，元素会连续返回，除非step设置得比step高，这会导致跳过项。如果stop为None，则继续迭代，直到迭代器耗尽为止;否则，它将在指定位置停止。与常规切片不同，islice（）不支持start，stop或step的负值。可以用于从内部结构已被扁平化的数据中提取相关字段(例如，多行报告可能每隔一行列出一个name字段)。<br>大致相当于:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">islice</span>(<span class="params">iterable, *args</span>):</span></span><br><span class="line">    <span class="comment"># islice(&#x27;ABCDEFG&#x27;, 2) --&gt; A B</span></span><br><span class="line">    <span class="comment"># islice(&#x27;ABCDEFG&#x27;, 2, 4) --&gt; C D</span></span><br><span class="line">    <span class="comment"># islice(&#x27;ABCDEFG&#x27;, 2, None) --&gt; C D E F G</span></span><br><span class="line">    <span class="comment"># islice(&#x27;ABCDEFG&#x27;, 0, None, 2) --&gt; A C E G</span></span><br><span class="line">    s = <span class="built_in">slice</span>(*args)</span><br><span class="line">    start, stop, step = s.start <span class="keyword">or</span> <span class="number">0</span>, s.stop <span class="keyword">or</span> sys.maxsize, s.step <span class="keyword">or</span> <span class="number">1</span></span><br><span class="line">    it = <span class="built_in">iter</span>(<span class="built_in">range</span>(start, stop, step))</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        nexti = <span class="built_in">next</span>(it)</span><br><span class="line">    <span class="keyword">except</span> StopIteration:</span><br><span class="line">        <span class="comment"># Consume *iterable* up to the *start* position.</span></span><br><span class="line">        <span class="keyword">for</span> i, element <span class="keyword">in</span> <span class="built_in">zip</span>(<span class="built_in">range</span>(start), iterable):</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">for</span> i, element <span class="keyword">in</span> <span class="built_in">enumerate</span>(iterable):</span><br><span class="line">            <span class="keyword">if</span> i == nexti:</span><br><span class="line">                <span class="keyword">yield</span> element</span><br><span class="line">                nexti = <span class="built_in">next</span>(it)</span><br><span class="line">    <span class="keyword">except</span> StopIteration:</span><br><span class="line">        <span class="comment"># Consume to *stop*.</span></span><br><span class="line">        <span class="keyword">for</span> i, element <span class="keyword">in</span> <span class="built_in">zip</span>(<span class="built_in">range</span>(i + <span class="number">1</span>, stop), iterable):</span><br><span class="line">            <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>

<p>如果start为None，那么迭代从0开始。如果step是None，那么step默认为1。</p>
<h3 id="itertools-starmap-function-iterable"><a href="#itertools-starmap-function-iterable" class="headerlink" title="itertools.starmap(function, iterable)"></a><strong>itertools.starmap(function, iterable)</strong></h3><p>将<code>iterable</code>中的每一项，映射到<code>function</code>中，并执行<code>function</code><br>大致相当于：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">starmap</span>(<span class="params">function, iterable</span>):</span></span><br><span class="line">    <span class="comment"># starmap(pow, [(2,5), (3,2), (10,3)]) --&gt; 32 9 1000</span></span><br><span class="line">    <span class="keyword">for</span> args <span class="keyword">in</span> iterable:</span><br><span class="line">        <span class="keyword">yield</span> function(*args)</span><br></pre></td></tr></table></figure>

<h3 id="itertools-takewhile-predicate-iterable"><a href="#itertools-takewhile-predicate-iterable" class="headerlink" title="itertools.takewhile(predicate, iterable)"></a><strong>itertools.takewhile(predicate, iterable)</strong></h3><p>只要使<code>predicate</code>为true，就返回。当遇到第一个为<code>False</code>的值就停止。与<a href="#dropwhile"><code>dropwhile</code></a>相反<br>大致相当于：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">takewhile</span>(<span class="params">predicate, iterable</span>):</span></span><br><span class="line">    <span class="comment"># takewhile(lambda x: x&lt;5, [1,4,6,4,1]) --&gt; 1 4</span></span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> iterable:</span><br><span class="line">        <span class="keyword">if</span> predicate(x):</span><br><span class="line">            <span class="keyword">yield</span> x</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br></pre></td></tr></table></figure>

<h3 id="itertools-tee-iterable-n-2"><a href="#itertools-tee-iterable-n-2" class="headerlink" title="itertools.tee(iterable, n=2)"></a><strong>itertools.tee(iterable, n=2)</strong></h3><p>从一个可迭代对象中返回n个独立的可迭代对象。</p>
<p>下面的代码会解释<code>tee</code>做了什么（虽然实际的解释会更复杂一些，并且只是用了一个单独的FIFO先进先出队列）。<br>大致相当于：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">tee</span>(<span class="params">iterable, n=<span class="number">2</span></span>):</span></span><br><span class="line">    it = <span class="built_in">iter</span>(iterable)</span><br><span class="line">    deques = [collections.deque() <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n)]</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">gen</span>(<span class="params">mydeque</span>):</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> mydeque:             <span class="comment"># when the local deque is empty</span></span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    newval = <span class="built_in">next</span>(it)   <span class="comment"># fetch a new value and</span></span><br><span class="line">                <span class="keyword">except</span> StopIteration:</span><br><span class="line">                    <span class="keyword">return</span></span><br><span class="line">                <span class="keyword">for</span> d <span class="keyword">in</span> deques:        <span class="comment"># load it to all the deques</span></span><br><span class="line">                    d.append(newval)</span><br><span class="line">            <span class="keyword">yield</span> mydeque.popleft()</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">tuple</span>(gen(d) <span class="keyword">for</span> d <span class="keyword">in</span> deques)</span><br></pre></td></tr></table></figure>

<p>实际这样用：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> tee</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(tee([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>], <span class="number">3</span>))  <span class="comment"># ==&gt;(&lt;itertools._tee object at 0x10cf787c8&gt;, &lt;itertools._tee object at 0x10cf78808&gt;, &lt;itertools._tee object at 0x10cf78848&gt;)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> a <span class="keyword">in</span> tee([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>], <span class="number">3</span>):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> a:</span><br><span class="line">        <span class="built_in">print</span>(i, end=<span class="string">&quot; &quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>()</span><br><span class="line"><span class="comment">#    1 2 3                  </span></span><br><span class="line"><span class="comment">#    1 2 3 </span></span><br><span class="line"><span class="comment">#    1 2 3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> a, b, c <span class="keyword">in</span> tee([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>], <span class="number">3</span>):</span><br><span class="line">    <span class="built_in">print</span>(a, b, c)</span><br><span class="line"><span class="comment">#    1 2 3                  </span></span><br><span class="line"><span class="comment">#    1 2 3 </span></span><br><span class="line"><span class="comment">#    1 2 3</span></span><br></pre></td></tr></table></figure>

<p>一旦tee（）进行了拆分，原始的iteable不应该在其他任何地方使用; 否则，迭代可以在没有通知tee对象的情况下进行。</p>
<p>这个itertool可能需要大量的辅助存储（取决于需要存储多少临时数据）。 通常，如果一个迭代器在另一个迭代器启动之前使用大部分或全部数据，则使用list（）而不是tee（）会更快。</p>
<h3 id="itertools-zip-longest-iterables-fillvalue-None"><a href="#itertools-zip-longest-iterables-fillvalue-None" class="headerlink" title="itertools.zip_longest(*iterables, fillvalue=None)"></a><strong>itertools.zip_longest(*iterables, fillvalue=None)</strong></h3><p>聚合每一个可迭代对象的元素。如果迭代的长度不均匀，则使用<code>fillvalue</code>填充缺失值。 迭代继续，直到最长的可迭代用尽。<br>大致相当于：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">zip_longest</span>(<span class="params">*args, fillvalue=<span class="literal">None</span></span>):</span></span><br><span class="line">    <span class="comment"># zip_longest(&#x27;ABCD&#x27;, &#x27;xy&#x27;, fillvalue=&#x27;-&#x27;) --&gt; Ax By C- D-</span></span><br><span class="line">    iterators = [<span class="built_in">iter</span>(it) <span class="keyword">for</span> it <span class="keyword">in</span> args]</span><br><span class="line">    num_active = <span class="built_in">len</span>(iterators)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> num_active:</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        values = []</span><br><span class="line">        <span class="keyword">for</span> i, it <span class="keyword">in</span> <span class="built_in">enumerate</span>(iterators):</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                value = <span class="built_in">next</span>(it)</span><br><span class="line">            <span class="keyword">except</span> StopIteration:</span><br><span class="line">                num_active -= <span class="number">1</span></span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> num_active:</span><br><span class="line">                    <span class="keyword">return</span></span><br><span class="line">                iterators[i] = repeat(fillvalue)</span><br><span class="line">                value = fillvalue</span><br><span class="line">            values.append(value)</span><br><span class="line">        <span class="keyword">yield</span> <span class="built_in">tuple</span>(values)</span><br></pre></td></tr></table></figure>

<p>如果其中一个iterables可能是无限的，那么<code>zip_longest()</code>函数应该包含一些限制调用次数的东西（例如<code>islice()</code>或<code>takewhile()</code>）。 如果未指定，则fillvalue默认为None。</p>
<h3 id="itertools-product-iterables-repeat-1"><a href="#itertools-product-iterables-repeat-1" class="headerlink" title="itertools.product(*iterables, repeat=1)"></a><strong>itertools.product(*iterables, repeat=1)</strong></h3><p>对放入的可迭代对象进行笛卡尔积运算。</p>
<p>大致相当于生成器表达式中的嵌套for循环。例如，<code>product(A, B)</code>的返回和<code>((x,y) for x in A for y in B)</code>一样</p>
<p>要计算iterable与其自身的乘积，请使用可选的repeat关键字参数指定重复次数。 例如，<code>product(A, repeat=4)</code>相当于<code>product(A, A, A, A)</code></p>
<p>此函数大致等同于以下代码，但实际实现不会在内存中构建中间结果：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">product</span>(<span class="params">*args, repeat=<span class="number">1</span></span>):</span></span><br><span class="line">    <span class="comment"># product(&#x27;ABCD&#x27;, &#x27;xy&#x27;) --&gt; Ax Ay Bx By Cx Cy Dx Dy</span></span><br><span class="line">    <span class="comment"># product(range(2), repeat=3) --&gt; 000 001 010 011 100 101 110 111</span></span><br><span class="line">    pools = [<span class="built_in">tuple</span>(pool) <span class="keyword">for</span> pool <span class="keyword">in</span> args] * repeat</span><br><span class="line">    result = [[]]</span><br><span class="line">    <span class="keyword">for</span> pool <span class="keyword">in</span> pools:</span><br><span class="line">        result = [x+[y] <span class="keyword">for</span> x <span class="keyword">in</span> result <span class="keyword">for</span> y <span class="keyword">in</span> pool]</span><br><span class="line">    <span class="keyword">for</span> prod <span class="keyword">in</span> result:</span><br><span class="line">        <span class="keyword">yield</span> <span class="built_in">tuple</span>(prod)</span><br></pre></td></tr></table></figure>

<h3 id="itertools-permutations-iterable-r-None"><a href="#itertools-permutations-iterable-r-None" class="headerlink" title="itertools.permutations(iterable, r=None)"></a><strong>itertools.permutations(iterable, r=None)</strong></h3><p>对可迭代对象进行组合排列，组合长度为<code>r</code><br>大致相当于：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">permutations</span>(<span class="params">iterable, r=<span class="literal">None</span></span>):</span></span><br><span class="line">    <span class="comment"># permutations(&#x27;ABCD&#x27;, 2) --&gt; AB AC AD BA BC BD CA CB CD DA DB DC</span></span><br><span class="line">    <span class="comment"># permutations(range(3)) --&gt; 012 021 102 120 201 210</span></span><br><span class="line">    pool = <span class="built_in">tuple</span>(iterable)</span><br><span class="line">    n = <span class="built_in">len</span>(pool)</span><br><span class="line">    r = n <span class="keyword">if</span> r <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">else</span> r</span><br><span class="line">    <span class="keyword">if</span> r &gt; n:</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    indices = <span class="built_in">list</span>(<span class="built_in">range</span>(n))</span><br><span class="line">    cycles = <span class="built_in">list</span>(<span class="built_in">range</span>(n, n-r, -<span class="number">1</span>))</span><br><span class="line">    <span class="keyword">yield</span> <span class="built_in">tuple</span>(pool[i] <span class="keyword">for</span> i <span class="keyword">in</span> indices[:r])</span><br><span class="line">    <span class="keyword">while</span> n:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">reversed</span>(<span class="built_in">range</span>(r)):</span><br><span class="line">            cycles[i] -= <span class="number">1</span></span><br><span class="line">            <span class="keyword">if</span> cycles[i] == <span class="number">0</span>:</span><br><span class="line">                indices[i:] = indices[i+<span class="number">1</span>:] + indices[i:i+<span class="number">1</span>]</span><br><span class="line">                cycles[i] = n - i</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                j = cycles[i]</span><br><span class="line">                indices[i], indices[-j] = indices[-j], indices[i]</span><br><span class="line">                <span class="keyword">yield</span> <span class="built_in">tuple</span>(pool[i] <span class="keyword">for</span> i <span class="keyword">in</span> indices[:r])</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span></span><br></pre></td></tr></table></figure>

<h3 id="itertools-combinations-iterable-r"><a href="#itertools-combinations-iterable-r" class="headerlink" title="itertools.combinations(iterable, r)"></a><strong>itertools.combinations(iterable, r)</strong></h3><p>和<a href="#permutations"><code>permutations</code></a>类似。但是不同的是，不会有忽略元素顺序的相同的组合</p>
<p>其相当于：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">combinations</span>(<span class="params">iterable, r</span>):</span></span><br><span class="line">    <span class="comment"># combinations(&#x27;ABCD&#x27;, 2) --&gt; AB AC AD BC BD CD</span></span><br><span class="line">    <span class="comment"># combinations(range(4), 3) --&gt; 012 013 023 123</span></span><br><span class="line">    pool = <span class="built_in">tuple</span>(iterable)</span><br><span class="line">    n = <span class="built_in">len</span>(pool)</span><br><span class="line">    <span class="keyword">if</span> r &gt; n:</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    indices = <span class="built_in">list</span>(<span class="built_in">range</span>(r))</span><br><span class="line">    <span class="keyword">yield</span> <span class="built_in">tuple</span>(pool[i] <span class="keyword">for</span> i <span class="keyword">in</span> indices)</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">reversed</span>(<span class="built_in">range</span>(r)):</span><br><span class="line">            <span class="keyword">if</span> indices[i] != i + n - r:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        indices[i] += <span class="number">1</span></span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(i+<span class="number">1</span>, r):</span><br><span class="line">            indices[j] = indices[j-<span class="number">1</span>] + <span class="number">1</span></span><br><span class="line">        <span class="keyword">yield</span> <span class="built_in">tuple</span>(pool[i] <span class="keyword">for</span> i <span class="keyword">in</span> indices)</span><br></pre></td></tr></table></figure>

<h3 id="itertools-combinations-with-replacement-iterable-r"><a href="#itertools-combinations-with-replacement-iterable-r" class="headerlink" title="itertools.combinations_with_replacement(iterable, r)"></a><strong>itertools.combinations_with_replacement(iterable, r)</strong></h3><p>和<a href="combinations"><code>combinations</code></a>相似。但不同的是，此方法返回的组合中，会有相同元素<br>其大致相当于：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">combinations_with_replacement</span>(<span class="params">iterable, r</span>):</span></span><br><span class="line">    <span class="comment"># combinations_with_replacement(&#x27;ABC&#x27;, 2) --&gt; AA AB AC BB BC CC</span></span><br><span class="line">    pool = <span class="built_in">tuple</span>(iterable)</span><br><span class="line">    n = <span class="built_in">len</span>(pool)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> n <span class="keyword">and</span> r:</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    indices = [<span class="number">0</span>] * r</span><br><span class="line">    <span class="keyword">yield</span> <span class="built_in">tuple</span>(pool[i] <span class="keyword">for</span> i <span class="keyword">in</span> indices)</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">reversed</span>(<span class="built_in">range</span>(r)):</span><br><span class="line">            <span class="keyword">if</span> indices[i] != n - <span class="number">1</span>:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        indices[i:] = [indices[i] + <span class="number">1</span>] * (r - i)</span><br><span class="line">        <span class="keyword">yield</span> <span class="built_in">tuple</span>(pool[i] <span class="keyword">for</span> i <span class="keyword">in</span> indices)</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://chuxiaoyi.github.io/2018/09/06/py3.7%E6%A0%87%E5%87%86%E5%BA%93-functools/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="chuxiaoyi">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="cxy">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/09/06/py3.7%E6%A0%87%E5%87%86%E5%BA%93-functools/" class="post-title-link" itemprop="url">py3.7标准库-functools</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-09-06 14:33:27" itemprop="dateCreated datePublished" datetime="2018-09-06T14:33:27+08:00">2018-09-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-06-10 18:16:29" itemprop="dateModified" datetime="2021-06-10T18:16:29+08:00">2021-06-10</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>16k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>14 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <span id="more"></span>

<p>参考文档：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/27643991">https://zhuanlan.zhihu.com/p/27643991</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.python.org/3.7/library/functools.html#functools.lru_cache">https://docs.python.org/3.7/library/functools.html#functools.lru_cache</a></li>
<li><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000009398663">https://segmentfault.com/a/1190000009398663</a></li>
</ul>
<h3 id="functools-cmp-to-key-func"><a href="#functools-cmp-to-key-func" class="headerlink" title="functools.cmp_to_key(func)"></a><strong>functools.cmp_to_key(func)</strong></h3><p>将旧式比较函数转换为关键字函数。与接受字关键函数(如sort()、min()、max()、heapq. nbiggest()、heapq.nsmallest()、itertools.groupby())的工具一起使用。该函数主要用于从Python 2转换过来的程序的转换工具，Python 2支持使用比较函数。</p>
<p>比较函数是任何可调用的函数，它接受两个参数，进行比较，然后返回负数(小于)、零(相等)或正数(大于)。键函数是一个可调用函数，它接受一个参数并返回另一个值作为排序键。</p>
<p>放上一波源码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">################################################################################</span></span><br><span class="line"><span class="comment">### cmp_to_key() function converter</span></span><br><span class="line"><span class="comment">################################################################################</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmp_to_key</span>(<span class="params">mycmp</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Convert a cmp= function into a key= function&quot;&quot;&quot;</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">K</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">        __slots__ = [<span class="string">&#x27;obj&#x27;</span>]</span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, obj</span>):</span></span><br><span class="line">            self.obj = obj</span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">__lt__</span>(<span class="params">self, other</span>):</span></span><br><span class="line">            <span class="keyword">return</span> mycmp(self.obj, other.obj) &lt; <span class="number">0</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">__gt__</span>(<span class="params">self, other</span>):</span></span><br><span class="line">            <span class="keyword">return</span> mycmp(self.obj, other.obj) &gt; <span class="number">0</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">__eq__</span>(<span class="params">self, other</span>):</span></span><br><span class="line">            <span class="keyword">return</span> mycmp(self.obj, other.obj) == <span class="number">0</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">__le__</span>(<span class="params">self, other</span>):</span></span><br><span class="line">            <span class="keyword">return</span> mycmp(self.obj, other.obj) &lt;= <span class="number">0</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">__ge__</span>(<span class="params">self, other</span>):</span></span><br><span class="line">            <span class="keyword">return</span> mycmp(self.obj, other.obj) &gt;= <span class="number">0</span></span><br><span class="line">        __hash__ = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">return</span> K</span><br></pre></td></tr></table></figure>

<p>写一个demo，看一下运行流程：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> functools</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyObject</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, val</span>):</span></span><br><span class="line">        self.val = val</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;MyObject(&#123;&#125;)&#x27;</span>.<span class="built_in">format</span>(self.val)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">compare_obj</span>(<span class="params">a, b</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Old-style comparison function.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;comparing &#123;&#125; and &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(a, b))</span><br><span class="line">    <span class="keyword">if</span> a.val &lt; b.val:</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span></span><br><span class="line">    <span class="keyword">elif</span> a.val &gt; b.val:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 排序的key</span></span><br><span class="line">get_key = functools.cmp_to_key(compare_obj)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_key_wrapper</span>(<span class="params">o</span>):</span></span><br><span class="line">    <span class="string">&quot;Wrapper function for get_key to allow for print statements.&quot;</span></span><br><span class="line">    new_key = get_key(o)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;key_wrapper(&#123;&#125;) -&gt; &#123;!r&#125;&#x27;</span>.<span class="built_in">format</span>(o, new_key))</span><br><span class="line">    <span class="keyword">return</span> new_key</span><br><span class="line"></span><br><span class="line">objs = [MyObject(x) <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>, <span class="number">0</span>, -<span class="number">1</span>)]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> o <span class="keyword">in</span> <span class="built_in">sorted</span>(objs, key=get_key_wrapper):</span><br><span class="line">    <span class="built_in">print</span>(o)</span><br></pre></td></tr></table></figure>

<p>通常情况下，<code>cmp_to_key()</code> 将直接使用，但在本例中引入了一个额外的包装函数，以在调用关键函数时输出更多信息。<br>输出如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">key_wrapper(MyObject(5)) -&gt; &lt;functools.KeyWrapper object at 0x10692e510&gt;</span><br><span class="line">key_wrapper(MyObject(4)) -&gt; &lt;functools.KeyWrapper object at 0x10692e4f0&gt;</span><br><span class="line">key_wrapper(MyObject(3)) -&gt; &lt;functools.KeyWrapper object at 0x10692e4d0&gt;</span><br><span class="line">key_wrapper(MyObject(2)) -&gt; &lt;functools.KeyWrapper object at 0x10692e470&gt;</span><br><span class="line">key_wrapper(MyObject(1)) -&gt; &lt;functools.KeyWrapper object at 0x10692e490&gt;</span><br><span class="line">comparing MyObject(4) and MyObject(5)</span><br><span class="line">comparing MyObject(3) and MyObject(4)</span><br><span class="line">comparing MyObject(2) and MyObject(3)</span><br><span class="line">comparing MyObject(1) and MyObject(2)</span><br><span class="line">MyObject(1)</span><br><span class="line">MyObject(2)</span><br><span class="line">MyObject(3)</span><br><span class="line">MyObject(4)</span><br><span class="line">MyObject(5)</span><br></pre></td></tr></table></figure>

<h3 id="functools-lru-cache-maxsize-128-typed-False"><a href="#functools-lru-cache-maxsize-128-typed-False" class="headerlink" title="@functools.lru_cache(maxsize=128, typed=False)"></a><strong>@functools.lru_cache(maxsize=128, typed=False)</strong></h3><p>这个装饰器实现了备忘的功能，是一项优化技术，把耗时的函数的结果保存起来，避免传入相同的参数时重复计算。lru 是（least recently used）的缩写，即最近最少使用原则。表明缓存不会无限制增长，一段时间不用的缓存条目会被扔掉。<br>这个装饰器支持传入参数，还能有这种操作的？maxsize 是保存最近多少个调用的结果，最好设置为 2 的倍数，默认为 128。如果设置为 None 的话就相当于是 maxsize 为正无穷了。还有一个参数是 type，如果 type 设置为 true，即把不同参数类型得到的结果分开保存，如 f(3) 和 f(3.0) 会被区分开。</p>
<p>由于字典用于缓存结果，因此函数的位置和关键字参数必须是hashable的。</p>
<p>如果maxsize设置为None，则禁用LRU特性，缓存可以无限制增长。当maxsize为2次方时，LRU特性表现最佳。</p>
<p>如果将类型设置为true，则将分别缓存不同类型的函数参数。例如，f(3)和f(3.0)将被视为具有不同结果的不同调用。</p>
<p>为了帮助度量缓存的有效性并调优maxsize参数，封装的函数使用cache_info()函数进行检测，该函数返回一个命名元组，显示hits(命中), misses(未命中)、maxsize和currsize。在多线程环境中，得失是近似的。</p>
<p>decorator还提供了一个cache_clear()函数，用于清除或使缓存失效。</p>
<p>原始的底层函数可以通过<strong>wrapped</strong>属性访问。这对于内省、绕过缓存或使用不同的缓存重新包装函数非常有用。</p>
<p>写了个函数追踪结果</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">track</span>(<span class="params">func</span>):</span></span><br><span class="line"><span class="meta">    @functools.wraps(<span class="params">func</span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">inner</span>(<span class="params">*args</span>):</span></span><br><span class="line">        result = func(*args)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;&#123;&#125; --&gt; (&#123;&#125;) --&gt; &#123;&#125; &quot;</span>.<span class="built_in">format</span>(func.__name__, args[<span class="number">0</span>], result))</span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line">    <span class="keyword">return</span> inner</span><br></pre></td></tr></table></figure>

<p>递归函数适合使用这个装饰器，那就拿经典的斐波那契数列来测试吧</p>
<p>不使用缓存</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@track</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fib</span>(<span class="params">n</span>):</span></span><br><span class="line">    <span class="keyword">if</span> n &lt; <span class="number">2</span>:</span><br><span class="line">        <span class="keyword">return</span> n</span><br><span class="line">    <span class="keyword">return</span> fib(n - <span class="number">2</span>) + fib(n - <span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<p>使用缓存</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@functools.lru_cache()</span></span><br><span class="line"><span class="meta">@track</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fib_with_cache</span>(<span class="params">n</span>):</span></span><br><span class="line">    <span class="keyword">if</span> n &lt; <span class="number">2</span>:</span><br><span class="line">        <span class="keyword">return</span> n</span><br><span class="line">    <span class="keyword">return</span> fib_with_cache(n - <span class="number">2</span>) + fib_with_cache(n - <span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<p>测试代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">fib(10)</span><br><span class="line"></span><br><span class="line">fib --&gt; (0) --&gt; 0 </span><br><span class="line">fib --&gt; (1) --&gt; 1 </span><br><span class="line">fib --&gt; (2) --&gt; 1 </span><br><span class="line">fib --&gt; (1) --&gt; 1 </span><br><span class="line">fib --&gt; (0) --&gt; 0 </span><br><span class="line">fib --&gt; (1) --&gt; 1 </span><br><span class="line">fib --&gt; (2) --&gt; 1 </span><br><span class="line">fib --&gt; (3) --&gt; 2 </span><br><span class="line">fib --&gt; (4) --&gt; 3 </span><br><span class="line">fib --&gt; (1) --&gt; 1 </span><br><span class="line">fib --&gt; (0) --&gt; 0 </span><br><span class="line">fib --&gt; (1) --&gt; 1 </span><br><span class="line">fib --&gt; (2) --&gt; 1 </span><br><span class="line">fib --&gt; (3) --&gt; 2 </span><br><span class="line">fib --&gt; (0) --&gt; 0 </span><br><span class="line">fib --&gt; (1) --&gt; 1 </span><br><span class="line">fib --&gt; (2) --&gt; 1 </span><br><span class="line">fib --&gt; (1) --&gt; 1 </span><br><span class="line">fib --&gt; (0) --&gt; 0 </span><br><span class="line">fib --&gt; (1) --&gt; 1 </span><br><span class="line">fib --&gt; (2) --&gt; 1 </span><br><span class="line">fib --&gt; (3) --&gt; 2 </span><br><span class="line">fib --&gt; (4) --&gt; 3 </span><br><span class="line">fib --&gt; (5) --&gt; 5 </span><br><span class="line">fib --&gt; (6) --&gt; 8 </span><br><span class="line">fib --&gt; (1) --&gt; 1 </span><br><span class="line">fib --&gt; (0) --&gt; 0 </span><br><span class="line">fib --&gt; (1) --&gt; 1 </span><br><span class="line">fib --&gt; (2) --&gt; 1 </span><br><span class="line">fib --&gt; (3) --&gt; 2 </span><br><span class="line">fib --&gt; (0) --&gt; 0 </span><br><span class="line">fib --&gt; (1) --&gt; 1 </span><br><span class="line">fib --&gt; (2) --&gt; 1 </span><br><span class="line">fib --&gt; (1) --&gt; 1 </span><br><span class="line">fib --&gt; (0) --&gt; 0 </span><br><span class="line">fib --&gt; (1) --&gt; 1 </span><br><span class="line">fib --&gt; (2) --&gt; 1 </span><br><span class="line">fib --&gt; (3) --&gt; 2 </span><br><span class="line">fib --&gt; (4) --&gt; 3 </span><br><span class="line">fib --&gt; (5) --&gt; 5 </span><br><span class="line">fib --&gt; (0) --&gt; 0 </span><br><span class="line">····省略····</span><br><span class="line"></span><br><span class="line">时间花费：0:00:00.001295</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">fib_with_cache(10)</span><br><span class="line"></span><br><span class="line">fib_with_cache --&gt; (0) --&gt; 0 </span><br><span class="line">fib_with_cache --&gt; (1) --&gt; 1 </span><br><span class="line">fib_with_cache --&gt; (2) --&gt; 1 </span><br><span class="line">fib_with_cache --&gt; (3) --&gt; 2 </span><br><span class="line">fib_with_cache --&gt; (4) --&gt; 3 </span><br><span class="line">fib_with_cache --&gt; (5) --&gt; 5 </span><br><span class="line">fib_with_cache --&gt; (6) --&gt; 8 </span><br><span class="line">fib_with_cache --&gt; (7) --&gt; 13 </span><br><span class="line">fib_with_cache --&gt; (8) --&gt; 21 </span><br><span class="line">fib_with_cache --&gt; (9) --&gt; 34 </span><br><span class="line">fib_with_cache --&gt; (10) --&gt; 55 </span><br><span class="line">时间花费：0:00:00.000117</span><br></pre></td></tr></table></figure>

<p>可以很明显的看到，使用缓存的时候，只调用了 11 次就得出了结果，并且花费时间只为 0.000117 秒</p>
<p>我们再把数字调大，传入的参数改为 31</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">fib(31)</span><br><span class="line"></span><br><span class="line">时间花费：0:00:41.323180</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">fib_with_cache(31)</span><br><span class="line"></span><br><span class="line">时间花费：0:00:00.000282</span><br></pre></td></tr></table></figure>

<p>时间相差居然如此之多！</p>
<p>这个装饰器还提供 cache_clear() 用于清理缓存，以及 cache_info() 用于查看缓存信息<br>官方还提供了另外一个例子，用于缓存静态网页的内容</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@lru_cache(<span class="params">maxsize=<span class="number">32</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_pep</span>(<span class="params">num</span>):</span></span><br><span class="line">    <span class="string">&#x27;Retrieve text of a Python Enhancement Proposal&#x27;</span></span><br><span class="line">    resource = <span class="string">&#x27;http://www.python.org/dev/peps/pep-%04d/&#x27;</span> % num</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> urllib.request.urlopen(resource) <span class="keyword">as</span> s:</span><br><span class="line">            <span class="keyword">return</span> s.read()</span><br><span class="line">    <span class="keyword">except</span> urllib.error.HTTPError:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;Not Found&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="functools-total-ordering"><a href="#functools-total-ordering" class="headerlink" title="@functools.total_ordering"></a><strong>@functools.total_ordering</strong></h3><p>给定一个类定义一个或多个丰富的比较排序方法，这个类装饰器提供其余的方法。这简化了指定所有可能的丰富比较操作所涉及的工作:</p>
<p>如果你已经定义了 <strong>eq</strong> 方法，以及 <strong>lt</strong>、<strong>le</strong>、<strong>gt</strong> 或者 <strong>ge</strong>() 其中之一， 即可自动生成其它比较方法。</p>
<p>上一波源码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">_convert = &#123;</span><br><span class="line">    <span class="string">&#x27;__lt__&#x27;</span>: [(<span class="string">&#x27;__gt__&#x27;</span>, _gt_from_lt),</span><br><span class="line">               (<span class="string">&#x27;__le__&#x27;</span>, _le_from_lt),</span><br><span class="line">               (<span class="string">&#x27;__ge__&#x27;</span>, _ge_from_lt)],</span><br><span class="line">    <span class="string">&#x27;__le__&#x27;</span>: [(<span class="string">&#x27;__ge__&#x27;</span>, _ge_from_le),</span><br><span class="line">               (<span class="string">&#x27;__lt__&#x27;</span>, _lt_from_le),</span><br><span class="line">               (<span class="string">&#x27;__gt__&#x27;</span>, _gt_from_le)],</span><br><span class="line">    <span class="string">&#x27;__gt__&#x27;</span>: [(<span class="string">&#x27;__lt__&#x27;</span>, _lt_from_gt),</span><br><span class="line">               (<span class="string">&#x27;__ge__&#x27;</span>, _ge_from_gt),</span><br><span class="line">               (<span class="string">&#x27;__le__&#x27;</span>, _le_from_gt)],</span><br><span class="line">    <span class="string">&#x27;__ge__&#x27;</span>: [(<span class="string">&#x27;__le__&#x27;</span>, _le_from_ge),</span><br><span class="line">               (<span class="string">&#x27;__gt__&#x27;</span>, _gt_from_ge),</span><br><span class="line">               (<span class="string">&#x27;__lt__&#x27;</span>, _lt_from_ge)]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">total_ordering</span>(<span class="params">cls</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Class decorator that fills in missing ordering methods&quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># Find user-defined comparisons (not those inherited from object).</span></span><br><span class="line">    roots = &#123;op <span class="keyword">for</span> op <span class="keyword">in</span> _convert <span class="keyword">if</span> <span class="built_in">getattr</span>(cls, op, <span class="literal">None</span>) <span class="keyword">is</span> <span class="keyword">not</span> <span class="built_in">getattr</span>(<span class="built_in">object</span>, op, <span class="literal">None</span>)&#125;</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> roots:</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">&#x27;must define at least one ordering operation: &lt; &gt; &lt;= &gt;=&#x27;</span>)</span><br><span class="line">    root = <span class="built_in">max</span>(roots)       <span class="comment"># prefer __lt__ to __le__ to __gt__ to __ge__</span></span><br><span class="line">    <span class="keyword">for</span> opname, opfunc <span class="keyword">in</span> _convert[root]:</span><br><span class="line">        <span class="keyword">if</span> opname <span class="keyword">not</span> <span class="keyword">in</span> roots:</span><br><span class="line">            opfunc.__name__ = opname</span><br><span class="line">            <span class="built_in">setattr</span>(cls, opname, opfunc)</span><br><span class="line">    <span class="keyword">return</span> cls</span><br></pre></td></tr></table></figure>

<p>来一个demo:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> total_ordering</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@total_ordering</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Door</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.value = <span class="number">0</span></span><br><span class="line">        self.first_name = <span class="string">&#x27;&#x27;</span></span><br><span class="line">        self.last_name = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__eq__</span>(<span class="params">self, other</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;=== my eq===&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> (self.first_name, self.last_name) == (other.first_name, other.last_name)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__gt__</span>(<span class="params">self, other</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;=== my total_ordering===&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> (self.first_name, self.last_name) &gt; (other.first_name, other.last_name)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">a = Door()</span><br><span class="line">b = Door()</span><br><span class="line"></span><br><span class="line">a.first_name = <span class="string">&#x27;ouyang&#x27;</span></span><br><span class="line">a.last_name = <span class="string">&#x27;guoge&#x27;</span></span><br><span class="line"></span><br><span class="line">b.first_name = <span class="string">&#x27;aaaa&#x27;</span></span><br><span class="line">b.last_name = <span class="string">&#x27;bbbb&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(a == b)</span><br><span class="line"><span class="built_in">print</span>(a &gt; b)</span><br><span class="line"><span class="built_in">print</span>(a &lt; b)</span><br><span class="line"><span class="built_in">print</span>(a &lt;= b)</span><br><span class="line"><span class="built_in">print</span>(a &gt;= b)</span><br></pre></td></tr></table></figure>

<p>结果输出为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">=== my eq===</span><br><span class="line">False</span><br><span class="line">=== my total_ordering===</span><br><span class="line">True</span><br><span class="line">=== my total_ordering===</span><br><span class="line">False</span><br><span class="line">=== my total_ordering===</span><br><span class="line">False</span><br><span class="line">=== my total_ordering===</span><br><span class="line">True</span><br></pre></td></tr></table></figure>

<h3 id="functools-partial-func-args-keywords"><a href="#functools-partial-func-args-keywords" class="headerlink" title="functools.partial(func, *args, **keywords)"></a><strong>functools.partial(func, *args, **keywords)</strong></h3><p>该方法返回一个新的局部对象，当被调用时，它的行为将像函数调用一样，带有位置参数args和关键字参数关键字。如果向调用提供了更多的参数，它们将被附加到args中。如果提供了额外的关键字参数，它们将扩展并覆盖关键字。大致相当于:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">partial</span>(<span class="params">func, *args, **keywords</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">newfunc</span>(<span class="params">*fargs, **fkeywords</span>):</span></span><br><span class="line">        newkeywords = keywords.copy()</span><br><span class="line">        newkeywords.update(fkeywords)</span><br><span class="line">        <span class="keyword">return</span> func(*args, *fargs, **newkeywords)</span><br><span class="line">    newfunc.func = func</span><br><span class="line">    newfunc.args = args</span><br><span class="line">    newfunc.keywords = keywords</span><br><span class="line">    <span class="keyword">return</span> newfunc</span><br></pre></td></tr></table></figure>

<p>partial()用于部分函数应用程序，该应用程序“冻结”函数参数和/或关键字的一部分，从而生成一个带有简化签名的新对象。例如，可以使用partial()创建一个可调用的函数，其行为类似于int()函数，其中基参数默认为2:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> functools <span class="keyword">import</span> partial</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>basetwo = partial(<span class="built_in">int</span>, base=<span class="number">2</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>basetwo.__doc__ = <span class="string">&#x27;Convert base 2 string to an int.&#x27;</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>basetwo(<span class="string">&#x27;10010&#x27;</span>)</span><br><span class="line"><span class="number">18</span></span><br></pre></td></tr></table></figure>

<p>上一波源码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">################################################################################</span></span><br><span class="line"><span class="comment">### partial() argument application</span></span><br><span class="line"><span class="comment">################################################################################</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Purely functional, no descriptor behaviour</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">partial</span>:</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;New function with partial application of the given arguments</span></span><br><span class="line"><span class="string">    and keywords.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    __slots__ = <span class="string">&quot;func&quot;</span>, <span class="string">&quot;args&quot;</span>, <span class="string">&quot;keywords&quot;</span>, <span class="string">&quot;__dict__&quot;</span>, <span class="string">&quot;__weakref__&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__new__</span>(<span class="params">*args, **keywords</span>):</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> args:</span><br><span class="line">            <span class="keyword">raise</span> TypeError(<span class="string">&quot;descriptor &#x27;__new__&#x27; of partial needs an argument&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(args) &lt; <span class="number">2</span>:</span><br><span class="line">            <span class="keyword">raise</span> TypeError(<span class="string">&quot;type &#x27;partial&#x27; takes at least one argument&quot;</span>)</span><br><span class="line">        cls, func, *args = args</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">callable</span>(func):</span><br><span class="line">            <span class="keyword">raise</span> TypeError(<span class="string">&quot;the first argument must be callable&quot;</span>)</span><br><span class="line">        args = <span class="built_in">tuple</span>(args)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">hasattr</span>(func, <span class="string">&quot;func&quot;</span>):</span><br><span class="line">            args = func.args + args</span><br><span class="line">            tmpkw = func.keywords.copy()</span><br><span class="line">            tmpkw.update(keywords)</span><br><span class="line">            keywords = tmpkw</span><br><span class="line">            <span class="keyword">del</span> tmpkw</span><br><span class="line">            func = func.func</span><br><span class="line"></span><br><span class="line">        self = <span class="built_in">super</span>(partial, cls).__new__(cls)</span><br><span class="line"></span><br><span class="line">        self.func = func</span><br><span class="line">        self.args = args</span><br><span class="line">        self.keywords = keywords</span><br><span class="line">        <span class="keyword">return</span> self</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span>(<span class="params">*args, **keywords</span>):</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> args:</span><br><span class="line">            <span class="keyword">raise</span> TypeError(<span class="string">&quot;descriptor &#x27;__call__&#x27; of partial needs an argument&quot;</span>)</span><br><span class="line">        self, *args = args</span><br><span class="line">        newkeywords = self.keywords.copy()</span><br><span class="line">        newkeywords.update(keywords)</span><br><span class="line">        <span class="keyword">return</span> self.func(*self.args, *args, **newkeywords)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @recursive_repr()</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span>(<span class="params">self</span>):</span></span><br><span class="line">        qualname = <span class="built_in">type</span>(self).__qualname__</span><br><span class="line">        args = [<span class="built_in">repr</span>(self.func)]</span><br><span class="line">        args.extend(<span class="built_in">repr</span>(x) <span class="keyword">for</span> x <span class="keyword">in</span> self.args)</span><br><span class="line">        args.extend(<span class="string">f&quot;<span class="subst">&#123;k&#125;</span>=<span class="subst">&#123;v!r&#125;</span>&quot;</span> <span class="keyword">for</span> (k, v) <span class="keyword">in</span> self.keywords.items())</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">type</span>(self).__module__ == <span class="string">&quot;functools&quot;</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">f&quot;functools.<span class="subst">&#123;qualname&#125;</span>(<span class="subst">&#123;<span class="string">&#x27;, &#x27;</span>.join(args)&#125;</span>)&quot;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;<span class="subst">&#123;qualname&#125;</span>(<span class="subst">&#123;<span class="string">&#x27;, &#x27;</span>.join(args)&#125;</span>)&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__reduce__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">type</span>(self), (self.func,), (self.func, self.args,</span><br><span class="line">               self.keywords <span class="keyword">or</span> <span class="literal">None</span>, self.__dict__ <span class="keyword">or</span> <span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__setstate__</span>(<span class="params">self, state</span>):</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(state, <span class="built_in">tuple</span>):</span><br><span class="line">            <span class="keyword">raise</span> TypeError(<span class="string">&quot;argument to __setstate__ must be a tuple&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(state) != <span class="number">4</span>:</span><br><span class="line">            <span class="keyword">raise</span> TypeError(<span class="string">f&quot;expected 4 items in state, got <span class="subst">&#123;<span class="built_in">len</span>(state)&#125;</span>&quot;</span>)</span><br><span class="line">        func, args, kwds, namespace = state</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">not</span> <span class="built_in">callable</span>(func) <span class="keyword">or</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(args, <span class="built_in">tuple</span>) <span class="keyword">or</span></span><br><span class="line">           (kwds <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(kwds, <span class="built_in">dict</span>)) <span class="keyword">or</span></span><br><span class="line">           (namespace <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(namespace, <span class="built_in">dict</span>))):</span><br><span class="line">            <span class="keyword">raise</span> TypeError(<span class="string">&quot;invalid partial state&quot;</span>)</span><br><span class="line"></span><br><span class="line">        args = <span class="built_in">tuple</span>(args) <span class="comment"># just in case it&#x27;s a subclass</span></span><br><span class="line">        <span class="keyword">if</span> kwds <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            kwds = &#123;&#125;</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">type</span>(kwds) <span class="keyword">is</span> <span class="keyword">not</span> <span class="built_in">dict</span>: <span class="comment"># XXX does it need to be *exactly* dict?</span></span><br><span class="line">            kwds = <span class="built_in">dict</span>(kwds)</span><br><span class="line">        <span class="keyword">if</span> namespace <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            namespace = &#123;&#125;</span><br><span class="line"></span><br><span class="line">        self.__dict__ = namespace</span><br><span class="line">        self.func = func</span><br><span class="line">        self.args = args</span><br><span class="line">        self.keywords = kwds</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">from</span> _functools <span class="keyword">import</span> partial</span><br><span class="line"><span class="keyword">except</span> ImportError:</span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>

<p>通过下面这个简单的demo，会更一目了然：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> partial</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">x, y</span>):</span></span><br><span class="line">    <span class="keyword">return</span> x + y</span><br><span class="line"></span><br><span class="line">add_y = partial(add, <span class="number">3</span>)  <span class="comment"># add_y 是一个函数</span></span><br><span class="line">add_y(<span class="number">4</span>)                 <span class="comment"># 结果是 7</span></span><br></pre></td></tr></table></figure>

<h3 id="functools-partialmethod-func-args-keywords"><a href="#functools-partialmethod-func-args-keywords" class="headerlink" title="*functools.partialmethod(func, *args, **keywords) *"></a><em>*functools.partialmethod(func, *args, **keywords) *</em></h3><p>返回一个新的partialmethod描述符，它的行为类似于partial，只是它被设计为作为方法定义使用，而不是直接调用。</p>
<p>func必须是描述符或可调用对象(与普通函数一样，这两种对象都作为描述符处理)。</p>
<p>当func是一个描述符(例如正常的Python函数、classmethod()、staticmethod()、abstractmethod()或partialmethod的另一个实例)时，对<strong>get</strong><br>的调用被委托给底层描述符，结果返回一个适当的部分对象。</p>
<p>当func是非描述符可调用时，会动态创建一个合适的绑定方法。当作为方法使用时，这就像一个普通的Python函数:self参数将作为第一个位置参数插入，甚至在提供给partialmethod构造函数的args和关键字之前。</p>
<p>举个栗子：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; class Cell(object):</span><br><span class="line">...     def __init__(self):</span><br><span class="line">...         self._alive = False</span><br><span class="line">...     @property</span><br><span class="line">...     def alive(self):</span><br><span class="line">...         return self._alive</span><br><span class="line">...     def set_state(self, state):</span><br><span class="line">...         self._alive = bool(state)</span><br><span class="line">...     set_alive = partialmethod(set_state, True)</span><br><span class="line">...     set_dead = partialmethod(set_state, False)</span><br><span class="line">...</span><br><span class="line">&gt;&gt;&gt; c = Cell()</span><br><span class="line">&gt;&gt;&gt; c.alive</span><br><span class="line">False</span><br><span class="line">&gt;&gt;&gt; c.set_alive()</span><br><span class="line">&gt;&gt;&gt; c.alive</span><br><span class="line">True</span><br></pre></td></tr></table></figure>

<h3 id="functools-reduce-function-iterable-initializer"><a href="#functools-reduce-function-iterable-initializer" class="headerlink" title="functools.reduce(function, iterable[, initializer])"></a><strong>functools.reduce(function, iterable[, initializer])</strong></h3><p>将两个参数的函数累加到序列的项上，从左到右，使序列减少到一个值。例如,<code>reduce(lambda x, y: x+y, [1, 2, 3, 4, 5])</code>计算<code>((((1 + 2)+(3)+ 4)+ 5)</code>。左边的参数x是累计值，右边的参数y是序列的更新值。如果存在可选初始化器，则该初始化器将放置在计算中序列项的前面，并在序列为空时充当缺省值。如果初始值设定项未给定，且序列仅包含一个项，则返回第一个项。</p>
<p>相当于：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">reduce</span>(<span class="params">function, iterable, initializer=<span class="literal">None</span></span>):</span></span><br><span class="line">    it = <span class="built_in">iter</span>(iterable)</span><br><span class="line">    <span class="keyword">if</span> initializer <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        value = <span class="built_in">next</span>(it)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        value = initializer</span><br><span class="line">    <span class="keyword">for</span> element <span class="keyword">in</span> it:</span><br><span class="line">        value = function(value, element)</span><br><span class="line">    <span class="keyword">return</span> value</span><br></pre></td></tr></table></figure>

<h3 id="functools-singledispatch"><a href="#functools-singledispatch" class="headerlink" title="@functools.singledispatch"></a><strong>@functools.singledispatch</strong></h3><p>使用过别的面向对象语言，如 java 等，肯定熟悉各种方法的重载，但是对于 Python 来说是不支持方法的重载的，不过其为我们提供了一个装饰器，能将普通函数变为泛函数（generic function）</p>
<p>比如你要针对不同类型的数据进行不同的处理，而又不想将它们写到一起，那就可以使用@singledispatch 装饰器了</p>
<p>举个例子：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> functools</span><br><span class="line"></span><br><span class="line"><span class="meta">@functools.singledispatch</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">typecheck</span>(<span class="params">text</span>):</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@typecheck.register(<span class="params"><span class="built_in">str</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_</span>(<span class="params">text</span>):</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">type</span>(text))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;str--&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@typecheck.register(<span class="params"><span class="built_in">list</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_</span>(<span class="params">text</span>):</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">type</span>(text))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;list--&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@typecheck.register(<span class="params"><span class="built_in">int</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_</span>(<span class="params">text</span>):</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">type</span>(text))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;int--&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    a = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>]</span><br><span class="line">    typecheck(a)</span><br></pre></td></tr></table></figure>

<p>看一下结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;class &#x27;list&#x27;&gt;</span><br><span class="line">list--</span><br></pre></td></tr></table></figure>

<p>换几个值试一下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a = 1</span><br><span class="line"></span><br><span class="line">&lt;class &#x27;int&#x27;&gt;</span><br><span class="line">int--</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a = &quot;aaaa&quot;</span><br><span class="line"></span><br><span class="line">&lt;class &#x27;str&#x27;&gt;</span><br><span class="line">str--</span><br></pre></td></tr></table></figure>

<p>singledispatch机制一个显著特征是，可以在系统的任何地方和任何模块中注册专门的函数，如果后来模块中增加了新的类型，可以轻松地添加一个新的专门函数来处理新类型。很像设计模式中的策略模式</p>
<h3 id="functools-update-wrapper-wrapper-wrapped-assigned-WRAPPER-ASSIGNMENTS-updated-WRAPPER-UPDATES"><a href="#functools-update-wrapper-wrapper-wrapped-assigned-WRAPPER-ASSIGNMENTS-updated-WRAPPER-UPDATES" class="headerlink" title="functools.update_wrapper(wrapper, wrapped, assigned=WRAPPER_ASSIGNMENTS, updated=WRAPPER_UPDATES)"></a><strong>functools.update_wrapper(wrapper, wrapped, assigned=WRAPPER_ASSIGNMENTS, updated=WRAPPER_UPDATES)</strong></h3><p>这个函数就是用来更新修饰器函数的，具体更新些什么呢，我们可以直接把它的源码搬过来看一下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">WRAPPER_ASSIGNMENTS = (<span class="string">&#x27;__module__&#x27;</span>, <span class="string">&#x27;__name__&#x27;</span>, <span class="string">&#x27;__qualname__&#x27;</span>, <span class="string">&#x27;__doc__&#x27;</span>,</span><br><span class="line">                       <span class="string">&#x27;__annotations__&#x27;</span>)</span><br><span class="line">WRAPPER_UPDATES = (<span class="string">&#x27;__dict__&#x27;</span>,)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">update_wrapper</span>(<span class="params">wrapper,</span></span></span><br><span class="line"><span class="params"><span class="function">                   wrapped,</span></span></span><br><span class="line"><span class="params"><span class="function">                   assigned = WRAPPER_ASSIGNMENTS,</span></span></span><br><span class="line"><span class="params"><span class="function">                   updated = WRAPPER_UPDATES</span>):</span></span><br><span class="line">    <span class="keyword">for</span> attr <span class="keyword">in</span> assigned:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            value = <span class="built_in">getattr</span>(wrapped, attr)</span><br><span class="line">        <span class="keyword">except</span> AttributeError:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">setattr</span>(wrapper, attr, value)</span><br><span class="line">    <span class="keyword">for</span> attr <span class="keyword">in</span> updated:</span><br><span class="line">        <span class="built_in">getattr</span>(wrapper, attr).update(<span class="built_in">getattr</span>(wrapped, attr, &#123;&#125;))</span><br><span class="line">    wrapper.__wrapped__ = wrapped</span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br></pre></td></tr></table></figure>

<p>大家可以发现，这个函数的作用就是从 被修饰的函数(wrapped) 中取出一些属性值来，赋值给 修饰器函数(wrapper) 。为什么要这么做呢，我们看下面这个例子。</p>
<p>首先我们写个自定义的修饰器，没有任何的功能，仅有文档字符串，如下所示：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">wrapper</span>(<span class="params">f</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper_function</span>(<span class="params">*args, **kwargs</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;这个是修饰函数&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> f(*args, **kwargs)</span><br><span class="line">    <span class="keyword">return</span> wrapper_function</span><br><span class="line"></span><br><span class="line"><span class="meta">@wrapper</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">wrapped</span>():</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;这个是被修饰的函数&quot;&quot;&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;wrapped&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(wrapped.__doc__)  <span class="comment"># 输出`这个是修饰函数`</span></span><br><span class="line"><span class="built_in">print</span>(wrapped.__name__)  <span class="comment"># 输出`wrapper_function`</span></span><br></pre></td></tr></table></figure>

<p>从上面的例子我们可以看到，我想要获取<code>wrapped</code>这个被修饰函数的文档字符串，但是却获取成了<code>wrapper_function</code>的文档字符串，<code>wrapped</code>函数的名字也变成了<code>wrapper_function</code>函数的名字。这是因为给<code>wrapped</code>添加上<code>@wrapper</code>修饰器相当于执行了一句<code>wrapped = wrapper(wrapped)</code>，执行完这条语句之后，<code>wrapped</code>函数就变成了<code>wrapper_function</code>函数。遇到这种情况该怎么办呢，首先我们可以手动地在<code>wrapper</code>函数中更改<code>wrapper_function</code>的<code>__doc__</code>和<code>__name__</code>属性，但聪明的你肯定也想到了，我们可以直接用<code>update_wrapper</code>函数来实现这个功能。</p>
<p>我们对上面定义的修饰器稍作修改，添加了一句update_wrapper(wrapper_function, f)。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> update_wrapper</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">wrapper</span>(<span class="params">f</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper_function</span>(<span class="params">*args, **kwargs</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;这个是修饰函数&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> f(*args, **kwargs)</span><br><span class="line">    update_wrapper(wrapper_function, f)  <span class="comment"># &lt;&lt;  添加了这条语句</span></span><br><span class="line">    <span class="keyword">return</span> wrapper_function</span><br><span class="line"></span><br><span class="line"><span class="meta">@wrapper</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">wrapped</span>():</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;这个是被修饰的函数&quot;&quot;&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;wrapped&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(wrapped.__doc__)  <span class="comment"># 输出`这个是被修饰的函数`</span></span><br><span class="line"><span class="built_in">print</span>(wrapped.__name__)  <span class="comment"># 输出`wrapped`</span></span><br></pre></td></tr></table></figure>

<p>此时我们可以发现，<code>__doc__</code>和<code>__name__</code>属性已经能够按我们预想的那样显示了，除此之外，<code>update_wrapper</code>函数也对<code>__module__</code>和<code>__dict__</code>等属性进行了更改和更新。</p>
<h3 id="functools-wraps-wrapped-assigned-WRAPPER-ASSIGNMENTS-updated-WRAPPER-UPDATES"><a href="#functools-wraps-wrapped-assigned-WRAPPER-ASSIGNMENTS-updated-WRAPPER-UPDATES" class="headerlink" title="@functools.wraps(wrapped, assigned=WRAPPER_ASSIGNMENTS, updated=WRAPPER_UPDATES)"></a><strong>@functools.wraps(wrapped, assigned=WRAPPER_ASSIGNMENTS, updated=WRAPPER_UPDATES)</strong></h3><p>看一下源码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">WRAPPER_ASSIGNMENTS = (<span class="string">&#x27;__module__&#x27;</span>, <span class="string">&#x27;__name__&#x27;</span>, <span class="string">&#x27;__qualname__&#x27;</span>, <span class="string">&#x27;__doc__&#x27;</span>,</span><br><span class="line">                       <span class="string">&#x27;__annotations__&#x27;</span>)</span><br><span class="line">WRAPPER_UPDATES = (<span class="string">&#x27;__dict__&#x27;</span>,)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">wraps</span>(<span class="params">wrapped,</span></span></span><br><span class="line"><span class="params"><span class="function">          assigned = WRAPPER_ASSIGNMENTS,</span></span></span><br><span class="line"><span class="params"><span class="function">          updated = WRAPPER_UPDATES</span>):</span></span><br><span class="line">    <span class="keyword">return</span> partial(update_wrapper, wrapped=wrapped,</span><br><span class="line">                   assigned=assigned, updated=updated)</span><br></pre></td></tr></table></figure>

<p>没错，就是这么的简单，只有这么一句，我们可以看出，wraps函数其实就是一个修饰器版的update_wrapper函数，它的功能和update_wrapper是一模一样的。我们可以修改我们上面的自定义修饰器的例子，做出一个更方便阅读的版本。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> wraps</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">wrapper</span>(<span class="params">f</span>):</span></span><br><span class="line"><span class="meta">    @wraps(<span class="params">f</span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper_function</span>(<span class="params">*args, **kwargs</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;这个是修饰函数&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> f(*args, **kwargs)</span><br><span class="line">    <span class="keyword">return</span> wrapper_function</span><br><span class="line"></span><br><span class="line"><span class="meta">@wrapper</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">wrapped</span>():</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;这个是被修饰的函数</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;wrapped&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(wrapped.__doc__)  <span class="comment"># 输出`这个是被修饰的函数`</span></span><br><span class="line"><span class="built_in">print</span>(wrapped.__name__)  <span class="comment"># 输出`wrapped`</span></span><br></pre></td></tr></table></figure>

<p><code>wraps</code>修饰器，其实就是将**被修饰的函数(wrapped)<strong>的一些属性值赋值给</strong>修饰器函数(wrapper)**，最终让属性的显示更符合我们的直觉。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://chuxiaoyi.github.io/2018/09/03/django-rest-framework%E6%96%87%E6%A1%A3%E6%95%B4%E7%90%86%E2%80%94%E2%80%94Request%20and%20Response%EF%BC%88%E4%BA%8C%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="chuxiaoyi">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="cxy">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/09/03/django-rest-framework%E6%96%87%E6%A1%A3%E6%95%B4%E7%90%86%E2%80%94%E2%80%94Request%20and%20Response%EF%BC%88%E4%BA%8C%EF%BC%89/" class="post-title-link" itemprop="url">django-rest-framework文档整理——Request and Response（二）</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-09-03 10:34:13" itemprop="dateCreated datePublished" datetime="2018-09-03T10:34:13+08:00">2018-09-03</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-06-10 18:16:29" itemprop="dateModified" datetime="2021-06-10T18:16:29+08:00">2021-06-10</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>5.2k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>5 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <span id="more"></span>

<p>从这里开始，我们将真正开始涵盖REST框架的核心。让我们介绍几个基本构建块。</p>
<h1 id="Request对象"><a href="#Request对象" class="headerlink" title="Request对象"></a>Request对象</h1><p>REST框架引入了一个 <code>Request</code>对象 用来扩展常规 <code>HttpRequest</code> 对象，并提供更灵活的请求解析。<code>Request</code> 对象的核心功能是 <code>request.data</code> 属性，它类似于 <code>request.POST</code> ，但对于使用Web API更有用。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">request.POST  # Only handles form data.  Only works for &#x27;POST&#x27; method.</span><br><span class="line">request.data  # Handles arbitrary data.  Works for &#x27;POST&#x27;, &#x27;PUT&#x27; and &#x27;PATCH&#x27; methods.</span><br></pre></td></tr></table></figure>

<h1 id="Response对象"><a href="#Response对象" class="headerlink" title="Response对象"></a>Response对象</h1><p>REST框架还引入了一个 <code>Response</code> 对象，这是TemplateResponse的一种类型，它接受未渲染的内容并根据内容来确定返回给客户端的正确内容类型。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">return Response(data)  # Renders to content type as requested by the client.</span><br></pre></td></tr></table></figure>

<h1 id="Status-codes"><a href="#Status-codes" class="headerlink" title="Status codes"></a>Status codes</h1><p>在视图中使用数字HTTP状态代码并不总能明显地读取数据，而且很容易忽略错误代码。REST框架为每个状态代码提供了更显式的标识符，例如状态模块中的 <code>HTTP_400_BAD_REQUEST</code> 。在整个过程中使用这些标识符是一个好主意，而不是使用数字标识符。</p>
<h1 id="包装API视图"><a href="#包装API视图" class="headerlink" title="包装API视图"></a>包装API视图</h1><p>REST框架提供了两个可用于编写API视图的装饰器。</p>
<ul>
<li><code>@api_view</code> 用于处理基于函数的视图的装饰器。</li>
<li><code>APIView</code> 类用于处理基于类的视图。</li>
</ul>
<p>这些包装器提供了一些功能，例如确保在视图中接收 <code>Request</code> 实例，并向 <code>Response</code> 对象添加上下文，以便执行内容协议。</p>
<p>包装器还提供一些行为，例如在适当的时候返回 <code>405 Method Not Allowed</code> 的响应，并且处理当错误的输入进入 <code>request.data</code>时造成的 <code>ParseError</code>异常</p>
<h1 id="组合起来"><a href="#组合起来" class="headerlink" title="组合起来"></a>组合起来</h1><p>好的，让我们继续并开始使用这些新组件来编写一些视图。</p>
<p>我们不再需要 <code>views.py</code> 中的 <code>JSONResponse</code> 类了，所以删除它。开始重构视图。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> status</span><br><span class="line"><span class="keyword">from</span> rest_framework.decorators <span class="keyword">import</span> api_view</span><br><span class="line"><span class="keyword">from</span> rest_framework.response <span class="keyword">import</span> Response</span><br><span class="line"><span class="keyword">from</span> snippets.models <span class="keyword">import</span> Snippet</span><br><span class="line"><span class="keyword">from</span> snippets.serializers <span class="keyword">import</span> SnippetSerializer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@api_view(<span class="params">[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">snippet_list</span>(<span class="params">request</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    List all code snippets, or create a new snippet.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;GET&#x27;</span>:</span><br><span class="line">        snippets = Snippet.objects.<span class="built_in">all</span>()</span><br><span class="line">        serializer = SnippetSerializer(snippets, many=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">return</span> Response(serializer.data)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">elif</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">        serializer = SnippetSerializer(data=request.data)</span><br><span class="line">        <span class="keyword">if</span> serializer.is_valid():</span><br><span class="line">            serializer.save()</span><br><span class="line">            <span class="keyword">return</span> Response(serializer.data, status=status.HTTP_201_CREATED)</span><br><span class="line">        <span class="keyword">return</span> Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)</span><br></pre></td></tr></table></figure>

<p>我们的实例视图是对前一个示例的改进。它更简洁一些，现在代码与我们使用Forms API非常相似。我们还使用命名的状态代码status code ，这使得响应更明确。</p>
<p>以下是 <code>views.py</code> 模块中单个snippet的视图。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@api_view(<span class="params">[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;PUT&#x27;</span>, <span class="string">&#x27;DELETE&#x27;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">snippet_detail</span>(<span class="params">request, pk</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Retrieve, update or delete a code snippet.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        snippet = Snippet.objects.get(pk=pk)</span><br><span class="line">    <span class="keyword">except</span> Snippet.DoesNotExist:</span><br><span class="line">        <span class="keyword">return</span> Response(status=status.HTTP_404_NOT_FOUND)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;GET&#x27;</span>:</span><br><span class="line">        serializer = SnippetSerializer(snippet)</span><br><span class="line">        <span class="keyword">return</span> Response(serializer.data)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">elif</span> request.method == <span class="string">&#x27;PUT&#x27;</span>:</span><br><span class="line">        serializer = SnippetSerializer(snippet, data=request.data)</span><br><span class="line">        <span class="keyword">if</span> serializer.is_valid():</span><br><span class="line">            serializer.save()</span><br><span class="line">            <span class="keyword">return</span> Response(serializer.data)</span><br><span class="line">        <span class="keyword">return</span> Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">elif</span> request.method == <span class="string">&#x27;DELETE&#x27;</span>:</span><br><span class="line">        snippet.delete()</span><br><span class="line">        <span class="keyword">return</span> Response(status=status.HTTP_204_NO_CONTENT)</span><br></pre></td></tr></table></figure>

<p>这应该都非常熟悉 - 与使用常规Django视图没有太大区别。</p>
<p>注意，我们不再显式地将请求或响应绑定到给定的content type。<code>request.data</code>可以处理传入的json请求，但也可以处理其他格式。类似的，我们将数据返回响应对象，但允许REST框架将响应渲染为正确的content type。</p>
<h1 id="向url添加可选格式后缀"><a href="#向url添加可选格式后缀" class="headerlink" title="向url添加可选格式后缀"></a>向url添加可选格式后缀</h1><p>为了利用我们的响应不再硬连接到单一内容类型的事实，让我们在API端点中添加对格式后缀的支持。使用格式后缀为我们提供了明确引用给定格式的url，这意味着我们的API能够处理诸如<code>http://example.com/api/items/4.json</code> 之类的url。</p>
<p>首先向两个视图都添加format关键字参数，如下所示。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">def snippet_list(request, format=None):</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">def snippet_detail(request, pk, format=None):</span><br></pre></td></tr></table></figure>

<p>现在更新 <code>snippets/urls.py</code> 文件，在现有url之外附加一组format_suffix_patterns。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.conf.urls <span class="keyword">import</span> url</span><br><span class="line"><span class="keyword">from</span> rest_framework.urlpatterns <span class="keyword">import</span> format_suffix_patterns</span><br><span class="line"><span class="keyword">from</span> snippets <span class="keyword">import</span> views</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    url(<span class="string">r&#x27;^snippets/$&#x27;</span>, views.snippet_list),</span><br><span class="line">    url(<span class="string">r&#x27;^snippets/(?P&lt;pk&gt;[0-9]+)$&#x27;</span>, views.snippet_detail),</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">urlpatterns = format_suffix_patterns(urlpatterns)</span><br></pre></td></tr></table></figure>

<p>我们不需要添加这些额外的url模式，但是它提供了一种简单、干净的方式来引用特定的格式。</p>
<h1 id="它看起来怎么样"><a href="#它看起来怎么样" class="headerlink" title="它看起来怎么样?"></a>它看起来怎么样?</h1><p>继续从命令行测试API，就像我们在<a target="_blank" rel="noopener" href="http://www.django-rest-framework.org/tutorial/1-serialization/">教程第1部分</a>中所做的那样。一切工作都非常相似，但是我们在发送无效请求时得到了更好的错误处理。<br>我们可以像以前一样得到所有snippets的列表。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">http http://127.0.0.1:8000/snippets/</span><br><span class="line"></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">...</span><br><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;id&quot;: 1,</span><br><span class="line">    &quot;title&quot;: &quot;&quot;,</span><br><span class="line">    &quot;code&quot;: &quot;foo = \&quot;bar\&quot;\n&quot;,</span><br><span class="line">    &quot;linenos&quot;: false,</span><br><span class="line">    &quot;language&quot;: &quot;python&quot;,</span><br><span class="line">    &quot;style&quot;: &quot;friendly&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;id&quot;: 2,</span><br><span class="line">    &quot;title&quot;: &quot;&quot;,</span><br><span class="line">    &quot;code&quot;: &quot;print \&quot;hello, world\&quot;\n&quot;,</span><br><span class="line">    &quot;linenos&quot;: false,</span><br><span class="line">    &quot;language&quot;: &quot;python&quot;,</span><br><span class="line">    &quot;style&quot;: &quot;friendly&quot;</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>我们可以通过使用Accept头来控制返回的响应的格式:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http http://127.0.0.1:8000/snippets/ Accept:application/json  # Request JSON</span><br><span class="line">http http://127.0.0.1:8000/snippets/ Accept:text/html         # Request HTML</span><br></pre></td></tr></table></figure>

<p>或加上格式后缀:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http http://127.0.0.1:8000/snippets.json  # JSON suffix</span><br><span class="line">http http://127.0.0.1:8000/snippets.api   # Browsable API suffix</span><br></pre></td></tr></table></figure>

<p>类似地，我们可以使用Content-Type头来控制发送请求的格式。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"># POST using form data</span><br><span class="line">http --form POST http://127.0.0.1:8000/snippets/ code=&quot;print 123&quot;</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;id&quot;: 3,</span><br><span class="line">  &quot;title&quot;: &quot;&quot;,</span><br><span class="line">  &quot;code&quot;: &quot;print 123&quot;,</span><br><span class="line">  &quot;linenos&quot;: false,</span><br><span class="line">  &quot;language&quot;: &quot;python&quot;,</span><br><span class="line">  &quot;style&quot;: &quot;friendly&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># POST using JSON</span><br><span class="line">http --json POST http://127.0.0.1:8000/snippets/ code=&quot;print 456&quot;</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    &quot;id&quot;: 4,</span><br><span class="line">    &quot;title&quot;: &quot;&quot;,</span><br><span class="line">    &quot;code&quot;: &quot;print 456&quot;,</span><br><span class="line">    &quot;linenos&quot;: false,</span><br><span class="line">    &quot;language&quot;: &quot;python&quot;,</span><br><span class="line">    &quot;style&quot;: &quot;friendly&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果您向上面的 <code>http</code> 请求添加 <code>—debug</code> 切换，您将能够在请求标头中看到请求类型。</p>
<p>现在，通过访问<a target="_blank" rel="noopener" href="http://127.0.0.1:8000/snippets/">http://127.0.0.1:8000/snippets/</a>，在web浏览器中打开API。</p>
<h1 id="可浏览性"><a href="#可浏览性" class="headerlink" title="可浏览性"></a>可浏览性</h1><p>因为API根据客户端请求选择响应的内容类型，所以默认情况下，当web浏览器请求该资源时，它将返回一个html格式的资源表示。这允许API返回完全web浏览的HTML表示。</p>
<p>有一个web浏览的API是一个巨大的可用性胜利，并且使开发和使用您的API更加容易。它还极大地降低了其他开发人员想要检查和使用您的API的门槛。</p>
<p>有关可浏览api特性以及如何自定义的更多信息，请参阅<a target="_blank" rel="noopener" href="http://www.django-rest-framework.org/topics/browsable-api/">可浏览api</a>主题。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://chuxiaoyi.github.io/2018/08/31/django-rest-framework%E6%96%87%E6%A1%A3%E6%95%B4%E7%90%86%E2%80%94%E2%80%94Serialization%EF%BC%88%E4%B8%80%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="chuxiaoyi">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="cxy">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/08/31/django-rest-framework%E6%96%87%E6%A1%A3%E6%95%B4%E7%90%86%E2%80%94%E2%80%94Serialization%EF%BC%88%E4%B8%80%EF%BC%89/" class="post-title-link" itemprop="url">django-rest-framework文档整理——Serialization（一）</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-08-31 17:18:44" itemprop="dateCreated datePublished" datetime="2018-08-31T17:18:44+08:00">2018-08-31</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-06-10 18:16:29" itemprop="dateModified" datetime="2021-06-10T18:16:29+08:00">2021-06-10</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>11k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>10 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <span id="more"></span>

<p>注意： 该笔记主要翻译自<a target="_blank" rel="noopener" href="http://www.django-rest-framework.org/tutorial/1-serialization/">官方文档</a></p>
<h1 id="入门"><a href="#入门" class="headerlink" title="入门"></a>入门</h1><p>首先，创建新项目</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">django-admin.py startproject tutorial</span><br><span class="line">cd tutorial</span><br></pre></td></tr></table></figure>

<p>完成后，我们可以创建一个我们将用于创建简单Web API的应用程序。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./manage.py startapp snippets</span><br></pre></td></tr></table></figure>

<p>我们需要添加我们的新 <code>snippets</code> 应用和 <code>rest_framework</code> 应用 <code>INSTALLED_APPS</code> 。让我们编辑 <code>tutorial/settings.py</code> 文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">INSTALLED_APPS = (</span><br><span class="line">    ...</span><br><span class="line">    &#x27;rest_framework&#x27;,</span><br><span class="line">    &#x27;snippets.apps.SnippetsConfig&#x27;,</span><br><span class="line">) </span><br></pre></td></tr></table></figure>

<p>好的，我们已经准备好了。</p>
<h1 id="创建一个模型"><a href="#创建一个模型" class="headerlink" title="创建一个模型"></a>创建一个模型</h1><p>首先，创建一个 <code>Snippet</code> 用于存储代码片段的简单model。继续编辑 <code>snippets/models.py</code> 文件</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"><span class="keyword">from</span> pygments.lexers <span class="keyword">import</span> get_all_lexers</span><br><span class="line"><span class="keyword">from</span> pygments.styles <span class="keyword">import</span> get_all_styles</span><br><span class="line"></span><br><span class="line">LEXERS = [item <span class="keyword">for</span> item <span class="keyword">in</span> get_all_lexers() <span class="keyword">if</span> item[<span class="number">1</span>]]</span><br><span class="line">LANGUAGE_CHOICES = <span class="built_in">sorted</span>([(item[<span class="number">1</span>][<span class="number">0</span>], item[<span class="number">0</span>]) <span class="keyword">for</span> item <span class="keyword">in</span> LEXERS])</span><br><span class="line">STYLE_CHOICES = <span class="built_in">sorted</span>((item, item) <span class="keyword">for</span> item <span class="keyword">in</span> get_all_styles())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Snippet</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    created = models.DateTimeField(auto_now_add=<span class="literal">True</span>)</span><br><span class="line">    title = models.CharField(max_length=<span class="number">100</span>, blank=<span class="literal">True</span>, default=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    code = models.TextField()</span><br><span class="line">    linenos = models.BooleanField(default=<span class="literal">False</span>)</span><br><span class="line">    language = models.CharField(choices=LANGUAGE_CHOICES, default=<span class="string">&#x27;python&#x27;</span>, max_length=<span class="number">100</span>)</span><br><span class="line">    style = models.CharField(choices=STYLE_CHOICES, default=<span class="string">&#x27;friendly&#x27;</span>, max_length=<span class="number">100</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        ordering = (<span class="string">&#x27;created&#x27;</span>,)</span><br></pre></td></tr></table></figure>

<p>我们还需要为我们的代码段模型创建初始迁移，并首次同步数据库。(这里使用的是默认的sqlite)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./manage.py makemigrations snippets</span><br><span class="line">./manage.py migrate</span><br></pre></td></tr></table></figure>

<h1 id="创建一个Serializer类"><a href="#创建一个Serializer类" class="headerlink" title="创建一个Serializer类"></a>创建一个Serializer类</h1><p>我们需要做的第一件事就是提供一个序列化和反序列化 <code>snippet</code> 实例的方法，并把它放到例如 <code>json</code> 中。我们可以通过声明与Django表单非常相似的序列化器来完成此操作。在 <code>snippets</code> 名为的目录中创建一个文件 <code>serializers.py</code> 并添加以下内容。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> serializers</span><br><span class="line"><span class="keyword">from</span> snippets.models <span class="keyword">import</span> Snippet, LANGUAGE_CHOICES, STYLE_CHOICES</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SnippetSerializer</span>(<span class="params">serializers.Serializer</span>):</span></span><br><span class="line">    <span class="built_in">id</span> = serializers.IntegerField(read_only=<span class="literal">True</span>)</span><br><span class="line">    title = serializers.CharField(required=<span class="literal">False</span>, allow_blank=<span class="literal">True</span>, max_length=<span class="number">100</span>)</span><br><span class="line">    code = serializers.CharField(style=&#123;<span class="string">&#x27;base_template&#x27;</span>: <span class="string">&#x27;textarea.html&#x27;</span>&#125;)</span><br><span class="line">    linenos = serializers.BooleanField(required=<span class="literal">False</span>)</span><br><span class="line">    language = serializers.ChoiceField(choices=LANGUAGE_CHOICES, default=<span class="string">&#x27;python&#x27;</span>)</span><br><span class="line">    style = serializers.ChoiceField(choices=STYLE_CHOICES, default=<span class="string">&#x27;friendly&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create</span>(<span class="params">self, validated_data</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Create and return a new `Snippet` instance, given the validated data.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> Snippet.objects.create(**validated_data)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">update</span>(<span class="params">self, instance, validated_data</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Update and return an existing `Snippet` instance, given the validated data.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        instance.title = validated_data.get(<span class="string">&#x27;title&#x27;</span>, instance.title)</span><br><span class="line">        instance.code = validated_data.get(<span class="string">&#x27;code&#x27;</span>, instance.code)</span><br><span class="line">        instance.linenos = validated_data.get(<span class="string">&#x27;linenos&#x27;</span>, instance.linenos)</span><br><span class="line">        instance.language = validated_data.get(<span class="string">&#x27;language&#x27;</span>, instance.language)</span><br><span class="line">        instance.style = validated_data.get(<span class="string">&#x27;style&#x27;</span>, instance.style)</span><br><span class="line">        instance.save()</span><br><span class="line">        <span class="keyword">return</span> instance</span><br></pre></td></tr></table></figure>

<p>serializer类定义了序列化/反序列化的字段。<code>create()</code> 和 <code>update()</code> 方法定义了在调用 <code>serializer.save()</code> 时实例如何被创建或修改</p>
<p>serializer类和django <code>Form</code> 类很相似，并且在各个字段上包含类似的验证标志，例如 <code>required</code> , <code>max_length</code> 和 <code>default</code>。</p>
<p>字段标志还可以控制在某些情况下应该如何显示序列化程序，例如在渲染HTML时。<code>&#123;&#39;base_template&#39;: &#39;textarea.html&#39;&#125;</code> 相当于在django <code>Form</code>类中使用 <code>widget=widgets.Textarea</code> 。这对于控制可浏览API的显示方式特别有用，我们将在本教程后面看到。</p>
<p>我们实际上也可以通过使用 <code>ModelSerializer</code> 类来节省一些时间，我们稍后会看到，但是现在我们先保持我们定义的serializer</p>
<h1 id="使用Serializers"><a href="#使用Serializers" class="headerlink" title="使用Serializers"></a>使用Serializers</h1><p>在进一步深入之前，我们将熟悉如何使用新的Serializer类。让我们进入Django shell。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python manage.py shell</span><br></pre></td></tr></table></figure>

<p>好的，一旦我们完成了一些导入，让我们创建几个代码片段来处理。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> snippets.models <span class="keyword">import</span> Snippet</span><br><span class="line"><span class="keyword">from</span> snippets.serializers <span class="keyword">import</span> SnippetSerializer</span><br><span class="line"><span class="keyword">from</span> rest_framework.renderers <span class="keyword">import</span> JSONRenderer</span><br><span class="line"><span class="keyword">from</span> rest_framework.parsers <span class="keyword">import</span> JSONParser</span><br><span class="line"></span><br><span class="line">snippet = Snippet(code=<span class="string">&#x27;foo = &quot;bar&quot;\n&#x27;</span>)</span><br><span class="line">snippet.save()</span><br><span class="line"></span><br><span class="line">snippet = Snippet(code=<span class="string">&#x27;print &quot;hello, world&quot;\n&#x27;</span>)</span><br><span class="line">snippet.save()</span><br></pre></td></tr></table></figure>

<p>我们现在有几个snippet实例可供使用。我们来看看序列化其中一个实例。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">serializer = SnippetSerializer(snippet)</span><br><span class="line">serializer.data</span><br><span class="line"># &#123;&#x27;id&#x27;: 2, &#x27;title&#x27;: u&#x27;&#x27;, &#x27;code&#x27;: u&#x27;print &quot;hello, world&quot;\n&#x27;, &#x27;linenos&#x27;: False, &#x27;language&#x27;: u&#x27;python&#x27;, &#x27;style&#x27;: u&#x27;friendly&#x27;&#125;</span><br></pre></td></tr></table></figure>

<p>此时我们已将model实例转换为Python自然数据类型。为了完成序列化过程，我们将数据渲染到 <code>json</code>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">content = JSONRenderer().render(serializer.data)</span><br><span class="line">content</span><br><span class="line"># &#x27;&#123;&quot;id&quot;: 2, &quot;title&quot;: &quot;&quot;, &quot;code&quot;: &quot;print \\&quot;hello, world\\&quot;\\n&quot;, &quot;linenos&quot;: false, &quot;language&quot;: &quot;python&quot;, &quot;style&quot;: &quot;friendly&quot;&#125;&#x27;</span><br></pre></td></tr></table></figure>

<p>反序列化是类似的。首先，我们将流解析为Python数据类型…</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.utils.six <span class="keyword">import</span> BytesIO</span><br><span class="line"></span><br><span class="line">stream = BytesIO(content)</span><br><span class="line">data = JSONParser().parse(stream)</span><br></pre></td></tr></table></figure>

<p>…然后我们将解析后的数据类型还原为完全填充的对象实例。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">serializer = SnippetSerializer(data=data)</span><br><span class="line">serializer.is_valid()</span><br><span class="line"># True</span><br><span class="line">serializer.validated_data</span><br><span class="line"># OrderedDict([(&#x27;title&#x27;, &#x27;&#x27;), (&#x27;code&#x27;, &#x27;print &quot;hello, world&quot;\n&#x27;), (&#x27;linenos&#x27;, False), (&#x27;language&#x27;, &#x27;python&#x27;), (&#x27;style&#x27;, &#x27;friendly&#x27;)])</span><br><span class="line">serializer.save()</span><br><span class="line"># &lt;Snippet: Snippet object&gt;</span><br></pre></td></tr></table></figure>

<p>请注意API与表单的相似程度。当我们开始编写使用序列化器的视图时，相似性应该变得更加明显。</p>
<p>我们还可以序列化querysets而不是model实例。为此，我们只需在序列化类中添加参数 <code>many=True</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">serializer = SnippetSerializer(Snippet.objects.all(), many=True)</span><br><span class="line">serializer.data</span><br><span class="line"># [OrderedDict([(&#x27;id&#x27;, 1), (&#x27;title&#x27;, u&#x27;&#x27;), (&#x27;code&#x27;, u&#x27;foo = &quot;bar&quot;\n&#x27;), (&#x27;linenos&#x27;, False), (&#x27;language&#x27;, &#x27;python&#x27;), (&#x27;style&#x27;, &#x27;friendly&#x27;)]), OrderedDict([(&#x27;id&#x27;, 2), (&#x27;title&#x27;, u&#x27;&#x27;), (&#x27;code&#x27;, u&#x27;print &quot;hello, world&quot;\n&#x27;), (&#x27;linenos&#x27;, False), (&#x27;language&#x27;, &#x27;python&#x27;), (&#x27;style&#x27;, &#x27;friendly&#x27;)]), OrderedDict([(&#x27;id&#x27;, 3), (&#x27;title&#x27;, u&#x27;&#x27;), (&#x27;code&#x27;, u&#x27;print &quot;hello, world&quot;&#x27;), (&#x27;linenos&#x27;, False), (&#x27;language&#x27;, &#x27;python&#x27;), (&#x27;style&#x27;, &#x27;friendly&#x27;)])]</span><br></pre></td></tr></table></figure>

<h1 id="使用ModelSerializers"><a href="#使用ModelSerializers" class="headerlink" title="使用ModelSerializers"></a>使用ModelSerializers</h1><p><code>SnippetSerializer</code> 类复制了很多信息，这些都包含在 <code>Snippet</code> 模型中。如果我们能够使代码更简洁，那将是很好的。</p>
<p>与Django提供 <code>Form</code> 类和 <code>ModelForm</code> 类的方式相同，REST框架包括 <code>Serializer</code> 类和 <code>ModelSerializer</code> 类。</p>
<p>让我们看看使用 <code>ModelSerializer</code> 类重构我们的序列化程序。再次打开 <code>snippets/serializers.py</code> 文件，并使用以下内容替换 <code>SnippetSerializer</code> 类。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SnippetSerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Snippet</span><br><span class="line">        fields = (<span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;title&#x27;</span>, <span class="string">&#x27;code&#x27;</span>, <span class="string">&#x27;linenos&#x27;</span>, <span class="string">&#x27;language&#x27;</span>, <span class="string">&#x27;style&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>序列化程序具有的一个不错的属性是，您可以通过打印其对象来检查序列化程序实例中的所有字段。打开Django shell <code>python manage.py shell</code> ，然后尝试以下操作：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">from snippets.serializers import SnippetSerializer</span><br><span class="line">serializer = SnippetSerializer()</span><br><span class="line">print(repr(serializer))</span><br><span class="line"># SnippetSerializer():</span><br><span class="line">#    id = IntegerField(label=&#x27;ID&#x27;, read_only=True)</span><br><span class="line">#    title = CharField(allow_blank=True, max_length=100, required=False)</span><br><span class="line">#    code = CharField(style=&#123;&#x27;base_template&#x27;: &#x27;textarea.html&#x27;&#125;)</span><br><span class="line">#    linenos = BooleanField(required=False)</span><br><span class="line">#    language = ChoiceField(choices=[(&#x27;Clipper&#x27;, &#x27;FoxPro&#x27;), (&#x27;Cucumber&#x27;, &#x27;Gherkin&#x27;), (&#x27;RobotFramework&#x27;, &#x27;RobotFramework&#x27;), (&#x27;abap&#x27;, &#x27;ABAP&#x27;), (&#x27;ada&#x27;, &#x27;Ada&#x27;)...</span><br><span class="line">#    style = ChoiceField(choices=[(&#x27;autumn&#x27;, &#x27;autumn&#x27;), (&#x27;borland&#x27;, &#x27;borland&#x27;), (&#x27;bw&#x27;, &#x27;bw&#x27;), (&#x27;colorful&#x27;, &#x27;colorful&#x27;)...</span><br></pre></td></tr></table></figure>

<p>重要的是要记住 <code>ModelSerializer</code> 类没有做任何特别神奇的事情，它们只是创建序列化程序类的快捷方式：</p>
<ul>
<li>自动确定字段集。</li>
<li><code>create()</code> 和 <code>update()</code>方法的简单默认实现。</li>
</ul>
<h1 id="使用我们的Serializer编写常规Django视图"><a href="#使用我们的Serializer编写常规Django视图" class="headerlink" title="使用我们的Serializer编写常规Django视图"></a>使用我们的Serializer编写常规Django视图</h1><p>让我们看看如何使用我们的新Serializer类编写一些API视图。目前我们不会使用任何REST框架的其他功能，我们只会将视图写为常规Django视图。<br>编辑 <code>snippets/views.py</code>文件，然后添加以下内容。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> HttpResponse, JsonResponse</span><br><span class="line"><span class="keyword">from</span> django.views.decorators.csrf <span class="keyword">import</span> csrf_exempt</span><br><span class="line"><span class="keyword">from</span> rest_framework.renderers <span class="keyword">import</span> JSONRenderer</span><br><span class="line"><span class="keyword">from</span> rest_framework.parsers <span class="keyword">import</span> JSONParser</span><br><span class="line"><span class="keyword">from</span> snippets.models <span class="keyword">import</span> Snippet</span><br><span class="line"><span class="keyword">from</span> snippets.serializers <span class="keyword">import</span> SnippetSerializer</span><br></pre></td></tr></table></figure>

<p>我们API的核心是一个支持列出所有存在的snippets，或创建一个新snippets的视图</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@csrf_exempt</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">snippet_list</span>(<span class="params">request</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    List all code snippets, or create a new snippet.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;GET&#x27;</span>:</span><br><span class="line">        snippets = Snippet.objects.<span class="built_in">all</span>()</span><br><span class="line">        serializer = SnippetSerializer(snippets, many=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(serializer.data, safe=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">elif</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">        data = JSONParser().parse(request)</span><br><span class="line">        serializer = SnippetSerializer(data=data)</span><br><span class="line">        <span class="keyword">if</span> serializer.is_valid():</span><br><span class="line">            serializer.save()</span><br><span class="line">            <span class="keyword">return</span> JsonResponse(serializer.data, status=<span class="number">201</span>)</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(serializer.errors, status=<span class="number">400</span>)</span><br></pre></td></tr></table></figure>

<p>请注意，因为我们希望能够从没有CSRF令牌的客户端POST到此视图，所以我们需要将视图标记为 <code>csrf_exempt</code> 。这不是您通常想要做的事情，REST框架视图实际上使用的行为比这更明智，但它现在可以用于我们的目的</p>
<p>我们还需要一个与单个snippet相对应的视图，并可用于检索，更新或删除代码段。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@csrf_exempt</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">snippet_detail</span>(<span class="params">request, pk</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Retrieve, update or delete a code snippet.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        snippet = Snippet.objects.get(pk=pk)</span><br><span class="line">    <span class="keyword">except</span> Snippet.DoesNotExist:</span><br><span class="line">        <span class="keyword">return</span> HttpResponse(status=<span class="number">404</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;GET&#x27;</span>:</span><br><span class="line">        serializer = SnippetSerializer(snippet)</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(serializer.data)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">elif</span> request.method == <span class="string">&#x27;PUT&#x27;</span>:</span><br><span class="line">        data = JSONParser().parse(request)</span><br><span class="line">        serializer = SnippetSerializer(snippet, data=data)</span><br><span class="line">        <span class="keyword">if</span> serializer.is_valid():</span><br><span class="line">            serializer.save()</span><br><span class="line">            <span class="keyword">return</span> JsonResponse(serializer.data)</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(serializer.errors, status=<span class="number">400</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">elif</span> request.method == <span class="string">&#x27;DELETE&#x27;</span>:</span><br><span class="line">        snippet.delete()</span><br><span class="line">        <span class="keyword">return</span> HttpResponse(status=<span class="number">204</span>)</span><br></pre></td></tr></table></figure>

<p>最后，我们需要链接这些视图。创建 <code>snippets/urls.py</code> 文件：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.conf.urls <span class="keyword">import</span> url</span><br><span class="line"><span class="keyword">from</span> snippets <span class="keyword">import</span> views</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    url(<span class="string">r&#x27;^snippets/$&#x27;</span>, views.snippet_list),</span><br><span class="line">    url(<span class="string">r&#x27;^snippets/(?P&lt;pk&gt;[0-9]+)/$&#x27;</span>, views.snippet_detail),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>我们还需要链接tutorial/urls.py文件中的根urlconf ，以包含我们的snippet应用的URL。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.conf.urls <span class="keyword">import</span> url, include</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    url(<span class="string">r&#x27;^&#x27;</span>, include(<span class="string">&#x27;snippets.urls&#x27;</span>)),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>值得注意的是，目前还有一些我们没有正确处理的边缘情况。如果我们发送错误的json，或者如果使用视图无法处理的方法发出请求，那么我们最终将得到500“服务器错误”响应。不过，现在这样做。</p>
<h1 id="测试我们对Web-API的第一次尝试"><a href="#测试我们对Web-API的第一次尝试" class="headerlink" title="测试我们对Web API的第一次尝试"></a>测试我们对Web API的第一次尝试</h1><p>现在我们启动服务器<br>退出shell。。。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">quit()</span><br></pre></td></tr></table></figure>

<p>并启动django服务器</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">./manage.py runserver</span><br><span class="line"></span><br><span class="line">Validating models...</span><br><span class="line"></span><br><span class="line">0 errors found</span><br><span class="line">Django version 1.11, using settings &#x27;tutorial.settings&#x27;</span><br><span class="line">Development server is running at http://127.0.0.1:8000/</span><br><span class="line">Quit the server with CONTROL-C.</span><br></pre></td></tr></table></figure>

<p>在另一个终端窗口中，我们可以测试服务器。</p>
<p>我们可以使用<a target="_blank" rel="noopener" href="https://curl.haxx.se/">curl</a>或<a target="_blank" rel="noopener" href="https://github.com/jakubroztocil/httpie#installation">httpie</a>测试我们的API 。Httpie是一个用Python编写的用户友好的http客户端。我们安装一下吧。</p>
<p>您可以使用pip安装httpie：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install httpie</span><br></pre></td></tr></table></figure>

<p>最后，我们可以获取所有snippets的列表信息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">http http://127.0.0.1:8000/snippets/</span><br><span class="line"></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">...</span><br><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;id&quot;: 1,</span><br><span class="line">    &quot;title&quot;: &quot;&quot;,</span><br><span class="line">    &quot;code&quot;: &quot;foo = \&quot;bar\&quot;\n&quot;,</span><br><span class="line">    &quot;linenos&quot;: false,</span><br><span class="line">    &quot;language&quot;: &quot;python&quot;,</span><br><span class="line">    &quot;style&quot;: &quot;friendly&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;id&quot;: 2,</span><br><span class="line">    &quot;title&quot;: &quot;&quot;,</span><br><span class="line">    &quot;code&quot;: &quot;print \&quot;hello, world\&quot;\n&quot;,</span><br><span class="line">    &quot;linenos&quot;: false,</span><br><span class="line">    &quot;language&quot;: &quot;python&quot;,</span><br><span class="line">    &quot;style&quot;: &quot;friendly&quot;</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>或者我们可以通过引用其id来获取特定snippet：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">http http://127.0.0.1:8000/snippets/2/</span><br><span class="line"></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">...</span><br><span class="line">&#123;</span><br><span class="line">  &quot;id&quot;: 2,</span><br><span class="line">  &quot;title&quot;: &quot;&quot;,</span><br><span class="line">  &quot;code&quot;: &quot;print \&quot;hello, world\&quot;\n&quot;,</span><br><span class="line">  &quot;linenos&quot;: false,</span><br><span class="line">  &quot;language&quot;: &quot;python&quot;,</span><br><span class="line">  &quot;style&quot;: &quot;friendly&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>同样，您可以通过在Web浏览器中访问这些URL来显示相同​​的json。</p>
<h1 id="我们现在在哪"><a href="#我们现在在哪" class="headerlink" title="我们现在在哪"></a>我们现在在哪</h1><p>到目前为止我们做得还不错，我们有一个序列化API，感觉非常类似于Django的Forms API，以及一些常规的Django视图。</p>
<p>我们的API视图目前没有做任何特别特别的事情，除了提供json响应之外，还有一些我们仍想清理的错误处理边缘情况，但它是一个正常运行的Web API。</p>
<p>我们将在本教程的第2部分中看到如何开始改进。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://chuxiaoyi.github.io/2018/08/09/Python%E4%B8%AD%E7%9A%84%E4%B8%8A%E4%B8%8B%E6%96%87%E7%AE%A1%E7%90%86%E5%99%A8%E5%92%8Cwith%E8%AF%AD%E5%8F%A5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="chuxiaoyi">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="cxy">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/08/09/Python%E4%B8%AD%E7%9A%84%E4%B8%8A%E4%B8%8B%E6%96%87%E7%AE%A1%E7%90%86%E5%99%A8%E5%92%8Cwith%E8%AF%AD%E5%8F%A5/" class="post-title-link" itemprop="url">Python中的上下文管理器和with语句</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-08-09 10:04:35" itemprop="dateCreated datePublished" datetime="2018-08-09T10:04:35+08:00">2018-08-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-06-10 18:16:29" itemprop="dateModified" datetime="2021-06-10T18:16:29+08:00">2021-06-10</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>1.9k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>2 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <span id="more"></span>

<p>转载来自：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/ybjourney/p/8859519.html">https://www.cnblogs.com/ybjourney/p/8859519.html</a></p>
<p>Python2.5之后引入了上下文管理器（context manager），算是Python的黑魔法之一，它用于规定某个对象的使用范围。本文是针对于该功能的思考总结。</p>
<h2 id="为什么需要上下文管理器？"><a href="#为什么需要上下文管理器？" class="headerlink" title="为什么需要上下文管理器？"></a>为什么需要上下文管理器？</h2><p>首先，需要思索下为什么需要引入上下文管理器。<br>在正常情况下，管理各种系统资源（如文件）、数据库连接时，通常是先打开这些资源，执行完相应的业务逻辑，最后关闭资源。<br>举两个例子:</p>
<blockquote>
<ul>
<li>使用Python打开一个文件写入内容，之后需要关闭这个文件。如果不正常关闭的话可能会在文件操作时出现异常，因为系统允许你打开的文件的最大数是有限的。</li>
<li>在数据库连接时也是存在类似问题，数据库的连接算是一种比较昂贵的资源，若连接过多而没有及时关闭的话，就可能出现不能继续连接的异常错误。</li>
</ul>
</blockquote>
<p>但是，很多程序员经常会忘记关闭文件，或者关闭数据库的连接。这时候就引入了上下文管理器，它可以在你不需要该对象的时候，自动关闭它。</p>
<h2 id="上下文管理器怎么使用？"><a href="#上下文管理器怎么使用？" class="headerlink" title="上下文管理器怎么使用？"></a>上下文管理器怎么使用？</h2><p>上下文管理器的语法是：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">with...as...</span><br></pre></td></tr></table></figure>

<p><strong>实例：文件操作</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span> <span class="string">&quot;不使用上下文管理器&quot;</span></span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;*&quot;</span> * <span class="number">30</span></span><br><span class="line">f = <span class="built_in">open</span>(<span class="string">&#x27;file.py&#x27;</span>, <span class="string">&#x27;w&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span> f.closed</span><br><span class="line">f.write(<span class="string">&quot;# Hello World&quot;</span>)</span><br><span class="line">f.close()</span><br><span class="line"><span class="built_in">print</span> f.closed</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;\n使用上下文管理器&quot;</span></span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;*&quot;</span> * <span class="number">30</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;file.py&quot;</span>, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="built_in">print</span> f.closed</span><br><span class="line">    f.write(<span class="string">&#x27;# Hello Python&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span> f.closed</span><br></pre></td></tr></table></figure>

<p>这里通过.closed比较，我们可以看到上下文管理器可以自动关闭文件，对于上下文管理器而言，有隶属于它的程序块，当隶属于它的程序块执行结束的时候（判断缩进），上下文管理器将自动关闭文件。<br>上述实例，也可以使用try…except…来实现，同样可以很直观的看到使用with…as…语句之后，代码确实相对更加简洁。</p>
<h2 id="上下文管理实现机制"><a href="#上下文管理实现机制" class="headerlink" title="上下文管理实现机制"></a>上下文管理实现机制</h2><p>因为文件对象是Python的内置对象，内置了上下文管理的特殊方法，所以它可以使用with语句。在Python中，任何对象，只要实现了上下文管理，就可以使用with语句，实现上下文管理需要通过<strong>enter</strong>和<strong>exit</strong>这两个方法来实现。<br>关于这两个方法：</p>
<ul>
<li>   enter(self)：进入该对象时调用此方法，返回值将放入with…as…语句中的as说明的变量中</li>
<li>   exit(self, type, value, tb):离开上下文管理器时调用该方法，如果有异常出现，返回False，type、value和tb将分别表示异常的类型、值和追踪信息，传递出上下文显示；如果没有异常，则三个变量的值均为None。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">with 上下文管理器：</span><br><span class="line">    语法体</span><br></pre></td></tr></table></figure>

<p>当with语句遇到上下文管理器时，就会在执行语法体之前，先执行<strong>enter</strong>方法，然后再执行语法体，执行完语法体之后，执行<strong>exit</strong>方法。</p>
<h2 id="上下文管理器实现"><a href="#上下文管理器实现" class="headerlink" title="上下文管理器实现"></a>上下文管理器实现</h2><p>使用Python2.7X实现一个上下文管理器:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Context</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">print</span> <span class="string">&quot;实例化一个对象&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__enter__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">print</span> <span class="string">&quot;获取该对象&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__exit__</span>(<span class="params">self, exc_type, exc_val, exc_tb</span>):</span></span><br><span class="line">        <span class="built_in">print</span> <span class="string">&quot;退出该对象&quot;</span></span><br><span class="line"></span><br><span class="line">temp = Context()</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> temp:</span><br><span class="line">    <span class="built_in">print</span> <span class="string">&quot;执行体&quot;</span></span><br></pre></td></tr></table></figure>

<p>这样，<strong>enter</strong>方法和<strong>exit</strong>方法的调用过程就很明晰。</p>
<h2 id="contextLib"><a href="#contextLib" class="headerlink" title="contextLib"></a>contextLib</h2><p>在contextlib中，提供了contextmanager装饰器，通过yield返回函数将函数分隔为两部分，yield之前的语句在<strong>enter</strong>中执行，yield之后的语句在<strong>exit</strong>中执行，简化了上下文管理器的实现方式：</p>
<p>总结：通过上下文管理器，我们可以更好的控制对象在不同区间的特性，并且可以使用with语句替代try…except方法，使得代码更加的简洁，主要的使用场景是访问资源，可以保证不管过程中是否发生错误或者异常都会执行相应的清理操作，释放出访问的资源。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://chuxiaoyi.github.io/2018/08/08/django%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98%E2%80%94%E2%80%94%E5%8D%9A%E5%AE%A2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="chuxiaoyi">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="cxy">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/08/08/django%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98%E2%80%94%E2%80%94%E5%8D%9A%E5%AE%A2/" class="post-title-link" itemprop="url">django项目开发实战——博客</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-08-08 17:53:22" itemprop="dateCreated datePublished" datetime="2018-08-08T17:53:22+08:00">2018-08-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-06-10 18:16:29" itemprop="dateModified" datetime="2021-06-10T18:16:29+08:00">2021-06-10</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>6.3k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>6 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <span id="more"></span>

<h3 id="p个大s："><a href="#p个大s：" class="headerlink" title="p个大s："></a>p个大s：</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">这里用的是python3.7和Django2.0.假设全都安装成功= =</span><br><span class="line">然后这个是我做个人网站的一个过程=。=</span><br><span class="line">然后这个也不能算是个教程吧=。=</span><br><span class="line">然后这只是粗糙的记录=。=</span><br><span class="line">最后，防脱发用霸王=3=</span><br></pre></td></tr></table></figure>

<h3 id="生成一个完整的django项目"><a href="#生成一个完整的django项目" class="headerlink" title="生成一个完整的django项目"></a>生成一个完整的django项目</h3><ul>
<li><p><strong>创建Django项目</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">django-admin.py startproject MySite</span><br></pre></td></tr></table></figure>

<p>此时，你会看到这样的文件夹：<br><img src="http://static.zybuluo.com/chuxiaoyi/49h3i95aw0oqoecmvefqd8l1/image_1cjvd08ra1bil15seqb71p312or9.png" alt="image_1cjvd08ra1bil15seqb71p312or9.png-6.5kB"></p>
</li>
<li><p><strong>运行一下你的项目，看看有没有成功</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./manage.py runserver</span><br></pre></td></tr></table></figure>

<p>终端会显示这些：<br><img src="http://static.zybuluo.com/chuxiaoyi/i4gc0elqc605ajy3f3vf69n8/image_1cjvd8tjj4aq48ihk21n4d1b38m.png" alt="image_1cjvd8tjj4aq48ihk21n4d1b38m.png-79kB"><br>有红字也不要担心，因为还没有设置呢！<br>接下来去<code>http://127.0.0.1:8000/</code>看一看：<br><img src="http://static.zybuluo.com/chuxiaoyi/n2ym6tgwxd9plj2uhzugpaxi/image_1cjvdb63b1bcl1jnpupct2610j423.png" alt="image_1cjvdb63b1bcl1jnpupct2610j423.png-121.7kB"><br>成功了！<br><strong>ps：</strong>如果想要外部机器（同一网络）访问本机的Django服务的话，要写成<code>./manage.py runserver 0.0.0.0:9999</code>,并将<code>setting.py</code>中的<code>ALLOWED_HOSTS</code>改为<code>ALLOWED_HOSTS = [&#39;*&#39;, ]</code>，一定要加<strong>逗号</strong>！</p>
</li>
<li><p><strong>改一些配置</strong><br><strong>ps</strong>：这里的顺序可能不对。= =</p>
<ol>
<li>更改<code>/MySite/MySite/settings.py</code>中的内容<br>Django默认的<code>DATABASES</code>是<code>sqlite</code>，是这样的：<br><img src="http://static.zybuluo.com/chuxiaoyi/v5k5xmi0xg796sduhoai22xt/image_1cjvdpm002a81skaf2714pr1f2t2g.png" alt="image_1cjvdpm002a81skaf2714pr1f2t2g.png-13.3kB"><br>这里我是用的是<code>MySQL</code>数据库，因此，我要改成这样：</li>
</ol>
  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">DATABASES = &#123;</span><br><span class="line"><span class="string">&#x27;default&#x27;</span>: &#123;</span><br><span class="line">    <span class="string">&#x27;ENGINE&#x27;</span>: <span class="string">&#x27;django.db.backends.mysql&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;NAME&#x27;</span>: <span class="string">&#x27;MySite&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;USER&#x27;</span>: <span class="string">&#x27;xxx&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;PASSWORD&#x27;</span>: <span class="string">&#x27;xxxxx&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;HOST&#x27;</span>: <span class="string">&#x27;127.0.0.1&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;PORT&#x27;</span>: <span class="string">&#x27;3306&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>  这里一定要确保数据库已经存在了。在这之前，需要创建数据库，像这样滴：</p>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create database MySite CHARACTER SET utf8 COLLATE utf8_general_ci;</span><br></pre></td></tr></table></figure>

<p>  还要更改<strong>时区</strong>和<strong>语言</strong><br>  <img src="http://static.zybuluo.com/chuxiaoyi/t8bc491f1uw4z71ij3vplcb1/image_1cjveevfspif39o6hm2mnucn3d.png" alt="image_1cjveevfspif39o6hm2mnucn3d.png-5.8kB"></p>
<ol start="2">
<li> 向<code>/MySite/MySite/__init__.py</code>中添加内容</li>
</ol>
  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pymysql</span><br><span class="line">pymysql.install_as_MySQLdb()</span><br></pre></td></tr></table></figure></li>
<li><p><strong>数据库迁移</strong><br>首先，执行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./manage.py makemigrations</span><br></pre></td></tr></table></figure>

<p>然后，执行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./manage.py migrate</span><br></pre></td></tr></table></figure>

<p>这样就成功啦～<br><img src="http://static.zybuluo.com/chuxiaoyi/ekq7zlcwi70z8znyr2jy1now/image_1cjvfbgkulc0gvt1gl9cu01sgd4a.png" alt="image_1cjvfbgkulc0gvt1gl9cu01sgd4a.png-70.9kB"></p>
</li>
<li><p><strong>创建超级用户</strong><br>创建超级用户是用来登陆到admin后台管理中的<br>执行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./manage.py createsuperuser</span><br></pre></td></tr></table></figure>

<p>然后按照提示填写就好啦～<br><strong>ps：</strong>一定要先进行数据库迁移，再创建用户。否则，会出现<img src="http://static.zybuluo.com/chuxiaoyi/du4zwcl0gkr8x9jc5o7vhpm1/image_1cjvfv00s1kuo119k1t8dh581ug84n.png" alt="image_1cjvfv00s1kuo119k1t8dh581ug84n.png-6.3kB"></p>
</li>
<li><p><strong>进入admin看看</strong><br>在浏览器中输入<code>http://127.0.0.1:8000/admin</code>，会出现登录页面，此时会发现全都变成中文了，说明之前的设置生效了。<br><img src="http://static.zybuluo.com/chuxiaoyi/tfogy4umjmduw5t0utatz3o2/image_1cjvg4n791bobtht1smbf1f1u7t54.png" alt="image_1cjvg4n791bobtht1smbf1f1u7t54.png-41.6kB"><br>接下来，就可以用刚刚创建的用户登陆了，查看后台数据了！</p>
</li>
</ul>
<h3 id="项目正式开始"><a href="#项目正式开始" class="headerlink" title="项目正式开始"></a>项目正式开始</h3><ul>
<li><p><strong>创建app</strong><br>执行<code>./manage.py startapp Post</code>,查看项目结构，如下：<br><img src="http://static.zybuluo.com/chuxiaoyi/gmgmt3mz41l9swzbv1axotyg/image_1cjvibkvpei29mk1doucvv12j15h.png" alt="image_1cjvibkvpei29mk1doucvv12j15h.png-10kB"></p>
<p>完成上步操作后，需要在<code>/MySite/MySite/settings.py</code>中将app添加进去：<br><img src="http://static.zybuluo.com/chuxiaoyi/cqlxbmom3dcu4sskz3s9jkd8/image_1cjvifci91ss01v9l1l1g1m5moo25u.png" alt="image_1cjvifci91ss01v9l1l1g1m5moo25u.png-14.5kB"><br>接下来，需要在app文件夹下添加<code>urls.py</code>，用于路由映射：<br><img src="http://static.zybuluo.com/chuxiaoyi/wv0tgog0pl8u2q8zcoq112um/image_1cjvilv4o14lf9a9371jkjhcr7o.png" alt="image_1cjvilv4o14lf9a9371jkjhcr7o.png-9.4kB"><br>在<code>urls.py</code>中这样写：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">app_name = <span class="string">&#x27;Post&#x27;</span>   <span class="comment"># 这里是为了url反向解析用</span></span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">  <span class="comment"># 这里放映射的view</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>同时，在<code>/MySite/MySite/urls.py</code>中需要添加对<code>Post.urls</code>的映射：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.contrib <span class="keyword">import</span> admin</span><br><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path, include</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">  path(<span class="string">&#x27;admin/&#x27;</span>, admin.site.urls),</span><br><span class="line">  path(<span class="string">r&#x27;&#x27;</span>, include(<span class="string">&#x27;Post.urls&#x27;</span>)),</span><br><span class="line">]</span><br></pre></td></tr></table></figure></li>
<li><p><strong>创建模型</strong><br>在app下的<code>models.py</code>创建自己的模型就可以啦~</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Category</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">  <span class="string">&quot;&quot;&quot;分类&quot;&quot;&quot;</span></span><br><span class="line">  name = models.CharField(max_length=<span class="number">100</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Tag</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">  <span class="string">&quot;&quot;&quot;标签&quot;&quot;&quot;</span></span><br><span class="line">  name = models.CharField(max_length=<span class="number">100</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Post</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">  <span class="string">&quot;&quot;&quot;文章&quot;&quot;&quot;</span></span><br><span class="line">  title = models.CharField(max_length=<span class="number">100</span>)</span><br><span class="line">  body = models.TextField()</span><br><span class="line">  created_time = models.DateTimeField()</span><br><span class="line">  modified_time = models.DateTimeField()</span><br><span class="line">  excerpt = models.CharField(max_length=<span class="number">200</span>, blank=<span class="literal">True</span>)  <span class="comment"># 文章摘要，可为空</span></span><br><span class="line">  category = models.ForeignKey(Category, on_delete=<span class="literal">True</span>)  <span class="comment"># ForeignKey表示1对多（多个post对应1个category）</span></span><br><span class="line">  tags = models.ManyToManyField(Tag, blank=<span class="literal">True</span>)</span><br><span class="line">  views = models.PositiveIntegerField(default=<span class="number">0</span>)  <span class="comment"># 阅读量</span></span><br></pre></td></tr></table></figure>

<p>然后一定不要忘记再进行<strong>数据库迁移</strong>啊！！</p>
</li>
<li><p><strong>前端模版</strong><br>这里的前端模板使用的是模板之家的<br>链接��：<a target="_blank" rel="noopener" href="http://www.cssmoban.com/tags.asp?n=html5">http://www.cssmoban.com/tags.asp?n=html5</a></p>
<p>首先创建templates目录，结构如下：<br><img src="http://static.zybuluo.com/chuxiaoyi/clj4spcx26385unz62hwxg26/image_1cjvlp6q840k17eg1cubd8i1qpi8i.png" alt="image_1cjvlp6q840k17eg1cubd8i1qpi8i.png-12.8kB"><br>此时，需要在<code>setting.py</code>中添加关于模板的配置：<br><img src="http://static.zybuluo.com/chuxiaoyi/qp8cowqr7rlu64tu0znzihgn/image_1cjvls24ohf91gngccsuk5ce8v.png" alt="image_1cjvls24ohf91gngccsuk5ce8v.png-39.8kB"></p>
<p>接下来是static目录，结构如下：<br><img src="http://static.zybuluo.com/chuxiaoyi/gfdqcztquhucuf7urxraech7/image_1cjvlvc96ir9hk4ubn1jk73uq9c.png" alt="image_1cjvlvc96ir9hk4ubn1jk73uq9c.png-9.5kB"><br>显而易见，这里放的是一些css、js文件等</p>
</li>
<li><p><strong>index视图</strong><br>首先，在<code>Post/views.py</code>中实现<code>index</code>方法：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span>(<span class="params">request</span>):</span></span><br><span class="line">  <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">  主页</span></span><br><span class="line"><span class="string">  :param request:</span></span><br><span class="line"><span class="string">  :return:</span></span><br><span class="line"><span class="string">  &quot;&quot;&quot;</span></span><br><span class="line">  <span class="keyword">return</span> render(request=request, template_name=<span class="string">&#x27;Post/index.html&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p><code>request</code>为请求对象;<br><code>template_name</code>为渲染的前端页面的路径字符串（相对templates目录）</p>
<p>然后，在<code>Post/urls.py</code>中进行路由映射：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">urlpatterns = [</span><br><span class="line">  url(<span class="string">r&#x27;^$&#x27;</span>, views.index, name=<span class="string">&quot;index&quot;</span>),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>注意：如果你主页的url是空，正则必须写成<strong>^$</strong></p>
<p>最后，一定要要修改静态页面中引用的路径。<br>对于Django来说，可以使用<code>static</code>标签。<br>在页面开头引入<code>&#123;% load static %&#125;</code>，这个对应的配置信息是<img src="http://static.zybuluo.com/chuxiaoyi/1oihspdgm87u6fs8xsyi7rs3/image_1ck6k15rg1j1lfei3j1aoepvha9.png" alt="image_1ck6k15rg1j1lfei3j1aoepvha9.png-2.7kB"><br>并将页面中的路径改为<img src="http://static.zybuluo.com/chuxiaoyi/yij56j7cs2lce5bzsd4d4mdp/image_1ck6k35as1gm97pr1gng1ch41ns7am.png" alt="image_1ck6k35as1gm97pr1gng1ch41ns7am.png-4.5kB"><br><strong>ps：</strong>对于css或者js中的引用也不要忘了改！</p>
<p>运行一下。<br><img src="http://static.zybuluo.com/chuxiaoyi/d5dremlh2i930xisccmz8d62/image_1ck6k74sv5p3212h1osclqub3.png" alt="image_1ck6k74sv5p3212h1osclqub3.png-422.3kB"><br>搞定！</p>
</li>
<li><p><strong>向前端渲染及分页</strong><br>首先，更改<code>index()</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> render</span><br><span class="line"><span class="keyword">from</span> django.core.paginator <span class="keyword">import</span> Paginator</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Post</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span>(<span class="params">request</span>):</span></span><br><span class="line">  <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">  主页</span></span><br><span class="line"><span class="string">  :param request:</span></span><br><span class="line"><span class="string">  :return:</span></span><br><span class="line"><span class="string">  &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">  post = Post.objects.<span class="built_in">all</span>()</span><br><span class="line"></span><br><span class="line">  limit = <span class="number">3</span></span><br><span class="line">  paginator = Paginator(post, limit)</span><br><span class="line">  page = request.GET.get(<span class="string">&#x27;page&#x27;</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">  result = paginator.page(page)</span><br><span class="line">  context = &#123;</span><br><span class="line">      <span class="string">&quot;post_list&quot;</span>: result,</span><br><span class="line">      <span class="string">&quot;page&quot;</span>: page</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> render(request=request, template_name=<span class="string">&#x27;Post/index.html&#x27;</span>, context=context)</span><br></pre></td></tr></table></figure>

<p>然后修改<code>index.html</code><br><img src="http://static.zybuluo.com/chuxiaoyi/y1tnpxlnteb4sdpfe39lh6hh/image_1ck6ueleqhgg1ml215qg8461hpkbg.png" alt="image_1ck6ueleqhgg1ml215qg8461hpkbg.png-122kB"></p>
<p>运行看一下<br><img src="http://static.zybuluo.com/chuxiaoyi/rl9rr4j86xh9eqzlhuk8vm2u/image_1ck6uhi34mt1nqi1a3i46p204bt.png" alt="image_1ck6uhi34mt1nqi1a3i46p204bt.png-173.5kB"><br>搞定！</p>
</li>
<li><p><strong>更改index.html中的所有跳转链接</strong><br>在这里，我用的是url的反向解析。这样可以减轻后期维护成本。因此，就需要在urls.py中添加如下信息：<br><img src="http://static.zybuluo.com/chuxiaoyi/xb662pip3z8x1271lcahbb35/image_1ck6vajq31hn72jkr4hjpe1dt1ca.png" alt="image_1ck6vajq31hn72jkr4hjpe1dt1ca.png-11.1kB"></p>
<p><img src="http://static.zybuluo.com/chuxiaoyi/mrayby38anpbctc28d2dmf3q/image_1ck6vb9cieha182n1eg12rt7qfcn.png" alt="image_1ck6vb9cieha182n1eg12rt7qfcn.png-7.8kB"><br>在html中修改成如下：<br><img src="http://static.zybuluo.com/chuxiaoyi/gz98bcgfeuyk3wl41rrswsi0/image_1ck6vcgaqlpe8dqsf8qnn17rndk.png" alt="image_1ck6vcgaqlpe8dqsf8qnn17rndk.png-3.5kB"></p>
</li>
<li><p><strong>博客文章页面</strong><br>别忘了改跳转链接！！！！<br>文章详情页和主页大体结构是相似的，因此，这里使用了模版继承。<br>在基类模版里，使用这个，将子类模版需要填充的位置占位<br><img src="http://static.zybuluo.com/chuxiaoyi/49j3eahshzer64j9h6nqpuoj/image_1ck99cgjpsqtjq41hnk148j1ak9.png" alt="image_1ck99cgjpsqtjq41hnk148j1ak9.png-4.6kB"><br>然后在子类模板中，使用相同的标签将填充的内容进行包裹<br>最后，不要忘了在子类模板中再写上<code>&#123;% extends 'Post/base.html' %&#125;</code>和<code>&#123;% load static %&#125;</code></p>
<p>在<code>Post/urls.py</code>中添加详情页的url：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url(r&#x27;^detail/post-(?P&lt;pk&gt;\d+)$&#x27;, views.detail, name=&quot;detail&quot;),</span><br></pre></td></tr></table></figure>

<p>并添加detail视图</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">detail</span>(<span class="params">request, pk</span>):</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">:param request: </span></span><br><span class="line"><span class="string">:param pk: 接收到的文章的主键id</span></span><br><span class="line"><span class="string">:return: </span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="keyword">return</span> render(request, template_name=<span class="string">&#x27;Post/blog.html&#x27;</span>, )</span><br></pre></td></tr></table></figure>

<p>运行看一下吧！<br><img src="http://static.zybuluo.com/chuxiaoyi/y4kk578e16p5tyeiyd7mhecl/image_1ck99kovo16t218tb11lo19k441mm.png" alt="image_1ck99kovo16t218tb11lo19k441mm.png-257kB"><br>搞定！<br>继续在视图中添加内容，将假数据改为真实的文章数据<br>对于多对多的关系来说，可以写成这样：<br><img src="http://static.zybuluo.com/chuxiaoyi/rnf7dr6w65lrn908p5f73rfu/image_1ck9hp2bkhnqamtcnbbm415813.png" alt="image_1ck9hp2bkhnqamtcnbbm415813.png-10.1kB"><br>看一看效果吧！<br><img src="http://static.zybuluo.com/chuxiaoyi/iplx5zoz3up0mlsm7k75j2ie/image_1ck9i8vcll104c16qd1i9r2k01g.png" alt="image_1ck9i8vcll104c16qd1i9r2k01g.png-264.3kB"></p>
<p>**接下来就是让我可以上传markdown格式的文本了！<br>这个暂时先不解决了= =，小本本记下来**</p>
</li>
<li><p><strong>添加分类栏</strong><br>这里使用自定义模版标签！<br>首先，在app文件夹下，创建<code>templatetags</code>文件夹，然后创建一个py文件，里面定义模版标签，目录是这样滴：<br><img src="http://static.zybuluo.com/chuxiaoyi/el867o3qwzqlek2v3f39bn9z/image_1ckc3ee0n117f10is15k8idd402d.png" alt="image_1ckc3ee0n117f10is15k8idd402d.png-9.9kB"></p>
<p>然后定义一个分类目录的标签：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django <span class="keyword">import</span> template</span><br><span class="line"><span class="keyword">from</span> ..models <span class="keyword">import</span> Category</span><br><span class="line"></span><br><span class="line">register = template.Library()</span><br><span class="line"></span><br><span class="line"><span class="meta">@register.simple_tag</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_categories</span>():</span></span><br><span class="line">  <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">  分类目录标签</span></span><br><span class="line"><span class="string">  :return:</span></span><br><span class="line"><span class="string">  &quot;&quot;&quot;</span></span><br><span class="line">  <span class="keyword">return</span> Category.objects.<span class="built_in">all</span>()</span><br></pre></td></tr></table></figure>

<p>在前端引用自定义标签时，一定要开头加载自定义的模版标签所在的py文件，<code>&#123;% load simple_tags %&#125;</code>,然后再使用：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;% get_categories as category_list %&#125;</span><br><span class="line">&#123;% for category in category_list %&#125;</span><br><span class="line">  <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;#&quot;</span>&gt;</span>&#123;&#123; category.name &#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure>

<p>看一下效果吧！<br><img src="http://static.zybuluo.com/chuxiaoyi/4i86entcw88n7jzapw847n57/%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_f1e71885-52fc-43e6-b722-a51dc80c8934.png" alt="企业微信截图_f1e71885-52fc-43e6-b722-a51dc80c8934.png-364.8kB"><br>搞定！</p>
</li>
<li><p><strong>评论功能</strong><br>评论功能新建一个app</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./manage.py startapp comment </span><br></pre></td></tr></table></figure>

<p>不要忘了把它注册到django中<br><img src="http://static.zybuluo.com/chuxiaoyi/cjebk0cdfykz15cnb347inx9/image_1ckc6rca21j8d73ogvq16a01cl01e.png" alt="image_1ckc6rca21j8d73ogvq16a01cl01e.png-15.2kB"></p>
<p>创建模型：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Comment</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">  name = models.CharField(max_length=<span class="number">20</span>)</span><br><span class="line">  email = models.EmailField(max_length=<span class="number">50</span>)</span><br><span class="line">  website = models.URLField(blank=<span class="literal">True</span>)</span><br><span class="line">  text = models.TextField()</span><br><span class="line">  created_time = models.DateTimeField(auto_now_add=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">  post = models.ForeignKey(<span class="string">&#x27;Post.Post&#x27;</span>, on_delete=<span class="literal">True</span>)  <span class="comment"># 一篇文章有多个评论</span></span><br></pre></td></tr></table></figure>

<p>不要忘了注册到admin中啊！</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">admin.site.register(Comment)</span><br></pre></td></tr></table></figure>

<p>最重要的一步。数据库迁移啊！！！</p>
<p>这里要实现的是点击submit按钮，会提交评论<br>在<code>comment/views.py</code>中添加视图：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> render, redirect</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Comment</span><br><span class="line"><span class="keyword">from</span> Post.models <span class="keyword">import</span> Post</span><br><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> reverse</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">submit_comment</span>(<span class="params">request, pk</span>):</span></span><br><span class="line">  <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">  处理提交的评论</span></span><br><span class="line"><span class="string">  :param request:</span></span><br><span class="line"><span class="string">  :return:</span></span><br><span class="line"><span class="string">  &quot;&quot;&quot;</span></span><br><span class="line">  post = request.POST</span><br><span class="line">  comment = Comment()</span><br><span class="line">  comment.name = post.get(<span class="string">&quot;name&quot;</span>)</span><br><span class="line">  comment.email = post.get(<span class="string">&#x27;email&#x27;</span>)</span><br><span class="line">  comment.website = post.get(<span class="string">&#x27;website&#x27;</span>)</span><br><span class="line">  comment.text = post.get(<span class="string">&#x27;message&#x27;</span>)</span><br><span class="line">  comment.post = Post.objects.get(<span class="built_in">id</span>=pk)</span><br><span class="line">  comment.save()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> redirect(reverse(<span class="string">&#x27;Post:detail&#x27;</span>, kwargs=&#123;<span class="string">&quot;pk&quot;</span>: pk&#125;))</span><br></pre></td></tr></table></figure>

<p>更改前端页面中的评论部分：<br><img src="http://static.zybuluo.com/chuxiaoyi/f5e47hed0uv3grf7qtdo1w8g/image_1ckcba269rui1u8a8rt1chqulf2r.png" alt="image_1ckcba269rui1u8a8rt1chqulf2r.png-37.9kB"></p>
<p>在<code>comment/urls.py</code>中添加映射：<br><img src="http://static.zybuluo.com/chuxiaoyi/19pzrwbl1kb170pul5v7x023/image_1ckcc3v5apog1quqljj7lrrh21p.png" alt="image_1ckcc3v5apog1quqljj7lrrh21p.png-13.1kB"><br>试一下吧！<br><img src="http://static.zybuluo.com/chuxiaoyi/jdgsbihsi0hdw5b56idjitl1/image_1ckcc59nn17vv1dqq1lot1lak8tk26.png" alt="image_1ckcc59nn17vv1dqq1lot1lak8tk26.png-24.9kB"><br>搞定！</p>
<p><strong>后面再完善一下。搞成可以回复的啵！小本本记下来～</strong></p>
</li>
<li><p><strong>最新评论</strong><br>这个也写成自定义标签啵。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@register.simple_tag</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_latest_comment</span>():</span></span><br><span class="line">  <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">  获取最新评论</span></span><br><span class="line"><span class="string">  :return:</span></span><br><span class="line"><span class="string">  &quot;&quot;&quot;</span></span><br><span class="line">  comment_list = Comment.objects.<span class="built_in">all</span>()[:<span class="number">5</span>].only(<span class="string">&#x27;post&#x27;</span>, <span class="string">&#x27;text&#x27;</span>)   <span class="comment"># 只获取特定字段</span></span><br><span class="line">  <span class="keyword">return</span> comment_list</span><br></pre></td></tr></table></figure>

<p><img src="http://static.zybuluo.com/chuxiaoyi/8ls7ecfp6838j3n0e0uzfgfv/image_1ckceclnl10r41ocn18rlu2mpfc2j.png" alt="image_1ckceclnl10r41ocn18rlu2mpfc2j.png-17.4kB"></p>
<p>看一下效果<br><img src="http://static.zybuluo.com/chuxiaoyi/4688zzma09v6kdfe0dorx8yv/image_1ckcef75i1ie51q421seb1rcu1lmm30.png" alt="image_1ckcef75i1ie51q421seb1rcu1lmm30.png-20.2kB"><br>搞定！</p>
</li>
<li><p><strong>阅读量</strong><br>在<code>Post/models.py</code>中添加：<br><img src="http://static.zybuluo.com/chuxiaoyi/1cm876ipp9l2m0ahh4hrjw1o/image_1ckcf0alj1l1u12a450avgf14323d.png" alt="image_1ckcf0alj1l1u12a450avgf14323d.png-71.1kB"></p>
<p>在<code>Post/views.py</code>中添加：<br><img src="http://static.zybuluo.com/chuxiaoyi/8bz7aaw3iqj6lxcx0vkvdgdd/image_1ckcf1coerbg1j2lroe2l91q9b3q.png" alt="image_1ckcf1coerbg1j2lroe2l91q9b3q.png-48.6kB"></p>
<p>在前端页面添加：<br><img src="http://static.zybuluo.com/chuxiaoyi/fy60nesb0nih1f8bnt2id1yh/image_1ckcf2edjfd11i6qg8e1vq51pfo47.png" alt="image_1ckcf2edjfd11i6qg8e1vq51pfo47.png-4.3kB"></p>
<p>搞定！<br><img src="http://static.zybuluo.com/chuxiaoyi/z7b8c2kehww2oufikser9o0d/image_1ckcf3k481u62unqtur1iis10ne5k.png" alt="image_1ckcf3k481u62unqtur1iis10ne5k.png-7.5kB"></p>
</li>
</ul>
<p>好啦～到这里博客基本成型了。就是不好看= =。然后后面继续完善。小本本记下来。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/3/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/5/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="chuxiaoyi"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">chuxiaoyi</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">41</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">categories</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">29</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/ChuXiaoYi" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;ChuXiaoYi" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:895706056@qq.com" title="E-Mail → mailto:895706056@qq.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://blog.csdn.net/weixin_40156487" title="https:&#x2F;&#x2F;blog.csdn.net&#x2F;weixin_40156487" rel="noopener" target="_blank">CSDN</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">chuxiaoyi</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="Symbols count total">219k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">3:19</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>

<script src="/js/bookmark.js"></script>




  















  

  

</body>
</html>
